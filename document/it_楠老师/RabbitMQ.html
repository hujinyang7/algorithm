<!DOCTYPE html>
<!-- saved from url=(0165)https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%A6%82%E8%BF%B0-%E4%BA%86%E8%A7%A3 -->
<html lang="zh-CN" class=" "><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.29">
    
    <link rel="modulepreload" href="./RabbitMQ_files/app.73a93177.js"><link rel="modulepreload" href="https://www.ydlclass.com/doc21xnv/assets/index.html.3a234d57.js"><link rel="modulepreload" href="https://www.ydlclass.com/doc21xnv/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="https://www.ydlclass.com/doc21xnv/assets/index.html.00054722.js">
    <link rel="stylesheet" href="./RabbitMQ_files/style.9c9488c6.css">
  <style type="text/css">.medium-zoom-overlay{position:fixed;top:0;right:0;bottom:0;left:0;opacity:0;transition:opacity .3s;will-change:opacity}.medium-zoom--opened .medium-zoom-overlay{cursor:pointer;cursor:zoom-out;opacity:1}.medium-zoom-image{cursor:pointer;cursor:zoom-in;transition:transform .3s cubic-bezier(.2,0,.2,1)!important}.medium-zoom-image--hidden{visibility:hidden}.medium-zoom-image--opened{position:relative;cursor:pointer;cursor:zoom-out;will-change:transform}</style><link rel="modulepreload" as="script" crossorigin="" href="https://www.ydlclass.com/doc21xnv/assets/linux.html.f47cd7eb.js"><link rel="modulepreload" as="script" crossorigin="" href="https://www.ydlclass.com/doc21xnv/assets/index.html.9fc471cb.js"><link rel="modulepreload" as="script" crossorigin="" href="https://www.ydlclass.com/doc21xnv/assets/index.html.20408418.js"><link rel="modulepreload" as="script" crossorigin="" href="https://www.ydlclass.com/doc21xnv/assets/index.html.4febcb1c.js"><link rel="modulepreload" as="script" crossorigin="" href="https://www.ydlclass.com/doc21xnv/assets/index.html.a7a319f5.js"><link rel="modulepreload" as="script" crossorigin="" href="https://www.ydlclass.com/doc21xnv/assets/index.html.68b7ffbb.js"><link rel="icon" href="https://www.ydlclass.com/image/favicon.ico"><title>RabbitMQ入门 | 文档合集</title><meta name="description" content="元动力课堂的课件，it楠老师，it李老师"></head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="https://www.ydlclass.com/doc21xnv/" class=""><img class="logo" src="./RabbitMQ_files/hero.png" alt="文档合集"><span class="site-name can-hide">文档合集</span></a></span><div class="navbar-links-wrapper" style="max-width: 1772px;"><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a class="nav-link external" href="https://www.ydlclass.com/" rel="noopener noreferrer" target="_blank" aria-label="首页"><!--[--><!--]--> 首页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="javase"><span class="title">javase</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="javase"><span class="title">javase</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/computer" class="nav-link" aria-label="1、计算机基础"> 1、计算机基础 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/variable" class="nav-link" aria-label="2、变量和标识符"> 2、变量和标识符 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/Flow" class="nav-link" aria-label="3、流程控制语句"> 3、流程控制语句 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/array" class="nav-link" aria-label="4、数组进阶"> 4、数组进阶 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/OOP" class="nav-link" aria-label="5、面向对象"> 5、面向对象 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/api" class="nav-link" aria-label="6、常用api"> 6、常用api </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/abnormal" class="nav-link" aria-label="7、异常处理"> 7、异常处理 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/generics" class="nav-link" aria-label="8、枚举和泛型"> 8、枚举和泛型 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/multithreading" class="nav-link" aria-label="9、多线程"> 9、多线程 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/tree" class="nav-link" aria-label="10、树"> 10、树 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/gather" class="nav-link" aria-label="11、集合框架"> 11、集合框架 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/IO" class="nav-link" aria-label="12、IO流"> 12、IO流 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/reflect" class="nav-link" aria-label="13、反射"> 13、反射 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/network" class="nav-link" aria-label="14、网络编程"> 14、网络编程 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/nio" class="nav-link" aria-label="15、nio"> 15、nio </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/regex" class="nav-link" aria-label="16、正则表达式"> 16、正则表达式 </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="基础课"><span class="title">基础课</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="基础课"><span class="title">基础课</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/basics/linux/linux.md" class="nav-link" aria-label="1、linux"> 1、linux </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/basics/git" class="nav-link" aria-label="2、git"> 2、git </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/database/mysql" class="nav-link" aria-label="1、mysql入门"> 1、mysql入门 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/database/jdbc" class="nav-link" aria-label="2、jdbc"> 2、jdbc </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1" class="nav-link" aria-label="3、mysql进阶-上"> 3、mysql进阶-上 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2" class="nav-link" aria-label="4、mysql进阶-下"> 4、mysql进阶-下 </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="javaweb"><span class="title">javaweb</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="javaweb"><span class="title">javaweb</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/html" class="nav-link" aria-label="1、html"> 1、html </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/css" class="nav-link" aria-label="2、css"> 2、css </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/js" class="nav-link" aria-label="3、js"> 3、js </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/bom" class="nav-link" aria-label="4、bom"> 4、bom </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/servlet" class="nav-link" aria-label="5、serlvet和jsp"> 5、serlvet和jsp </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="框架篇"><span class="title">框架篇</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="框架篇"><span class="title">框架篇</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/data" class="nav-link" aria-label="1、日志框架"> 1、日志框架 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/maven" class="nav-link" aria-label="2、maven"> 2、maven </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/design" class="nav-link" aria-label="3、设计模式"> 3、设计模式 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/mybatis" class="nav-link" aria-label="4、mybatis"> 4、mybatis </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/spring" class="nav-link" aria-label="5、spring"> 5、spring </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/springmvc" class="nav-link" aria-label="6、springMVC"> 6、springMVC </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/mybatisplus" class="nav-link" aria-label="7、mybatisplus"> 7、mybatisplus </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/redis" class="nav-link" aria-label="8、redis"> 8、redis </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/ssm" class="nav-link" aria-label="9、ssm练手项目"> 9、ssm练手项目 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/springboot" class="nav-link" aria-label="10、springboot"> 10、springboot </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/jpa/jpa" class="nav-link" aria-label="11、springdata-jpa"> 11、springdata-jpa </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="分布式篇和组件"><span class="title">分布式篇和组件</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="分布式篇和组件"><span class="title">分布式篇和组件</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/nginx" class="nav-link" aria-label="1、nginx"> 1、nginx </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/springcloud/springCloud" class="nav-link" aria-label="2、springcloud"> 2、springcloud </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/springcloud/springCloudAlibaba" class="nav-link" aria-label="3、springcloudAlibaba"> 3、springcloudAlibaba </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/distribute/elk/elk1" class="nav-link" aria-label="4、elk1"> 4、elk1 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/distribute/elk/elk2" class="nav-link" aria-label="5、elk2"> 5、elk2 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/distribute/rocketmq/" class="nav-link" aria-label="6、rocketmq"> 6、rocketmq </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="7、rabbitmq" aria-current="page"> 7、rabbitmq </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/docker/" class="nav-link" aria-label="8、docker"> 8、docker </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="项目篇"><span class="title">项目篇</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="项目篇"><span class="title">项目篇</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/project/message/" class="nav-link" aria-label="1、短信调度"> 1、短信调度 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/" class="nav-link" aria-label="2、二奢交易网-上"> 2、二奢交易网-上 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/" class="nav-link" aria-label="2、二奢交易网-中"> 2、二奢交易网-中 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/" class="nav-link" aria-label="2、二奢交易网-下"> 2、二奢交易网-下 </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="算法篇"><span class="title">算法篇</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="算法篇"><span class="title">算法篇</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/algorithm/sort" class="nav-link" aria-label="1、排序"> 1、排序 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/algorithm/base" class="nav-link" aria-label="2、必会算法"> 2、必会算法 </a></li></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value=""><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a class="nav-link external" href="https://www.ydlclass.com/" rel="noopener noreferrer" target="_blank" aria-label="首页"><!--[--><!--]--> 首页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="javase"><span class="title">javase</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="javase"><span class="title">javase</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/computer" class="nav-link" aria-label="1、计算机基础"> 1、计算机基础 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/variable" class="nav-link" aria-label="2、变量和标识符"> 2、变量和标识符 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/Flow" class="nav-link" aria-label="3、流程控制语句"> 3、流程控制语句 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/array" class="nav-link" aria-label="4、数组进阶"> 4、数组进阶 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/OOP" class="nav-link" aria-label="5、面向对象"> 5、面向对象 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/api" class="nav-link" aria-label="6、常用api"> 6、常用api </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/abnormal" class="nav-link" aria-label="7、异常处理"> 7、异常处理 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/generics" class="nav-link" aria-label="8、枚举和泛型"> 8、枚举和泛型 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/multithreading" class="nav-link" aria-label="9、多线程"> 9、多线程 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/tree" class="nav-link" aria-label="10、树"> 10、树 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/gather" class="nav-link" aria-label="11、集合框架"> 11、集合框架 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/IO" class="nav-link" aria-label="12、IO流"> 12、IO流 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/reflect" class="nav-link" aria-label="13、反射"> 13、反射 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/network" class="nav-link" aria-label="14、网络编程"> 14、网络编程 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/nio" class="nav-link" aria-label="15、nio"> 15、nio </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javase/regex" class="nav-link" aria-label="16、正则表达式"> 16、正则表达式 </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="基础课"><span class="title">基础课</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="基础课"><span class="title">基础课</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/basics/linux/linux.md" class="nav-link" aria-label="1、linux"> 1、linux </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/basics/git" class="nav-link" aria-label="2、git"> 2、git </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/database/mysql" class="nav-link" aria-label="1、mysql入门"> 1、mysql入门 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/database/jdbc" class="nav-link" aria-label="2、jdbc"> 2、jdbc </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1" class="nav-link" aria-label="3、mysql进阶-上"> 3、mysql进阶-上 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2" class="nav-link" aria-label="4、mysql进阶-下"> 4、mysql进阶-下 </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="javaweb"><span class="title">javaweb</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="javaweb"><span class="title">javaweb</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/html" class="nav-link" aria-label="1、html"> 1、html </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/css" class="nav-link" aria-label="2、css"> 2、css </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/js" class="nav-link" aria-label="3、js"> 3、js </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/bom" class="nav-link" aria-label="4、bom"> 4、bom </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/javaweb/servlet" class="nav-link" aria-label="5、serlvet和jsp"> 5、serlvet和jsp </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="框架篇"><span class="title">框架篇</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="框架篇"><span class="title">框架篇</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/data" class="nav-link" aria-label="1、日志框架"> 1、日志框架 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/maven" class="nav-link" aria-label="2、maven"> 2、maven </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/design" class="nav-link" aria-label="3、设计模式"> 3、设计模式 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/mybatis" class="nav-link" aria-label="4、mybatis"> 4、mybatis </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/spring" class="nav-link" aria-label="5、spring"> 5、spring </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/springmvc" class="nav-link" aria-label="6、springMVC"> 6、springMVC </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/mybatisplus" class="nav-link" aria-label="7、mybatisplus"> 7、mybatisplus </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/redis" class="nav-link" aria-label="8、redis"> 8、redis </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/ssm" class="nav-link" aria-label="9、ssm练手项目"> 9、ssm练手项目 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/springboot" class="nav-link" aria-label="10、springboot"> 10、springboot </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/frame/jpa/jpa" class="nav-link" aria-label="11、springdata-jpa"> 11、springdata-jpa </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="分布式篇和组件"><span class="title">分布式篇和组件</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="分布式篇和组件"><span class="title">分布式篇和组件</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/nginx" class="nav-link" aria-label="1、nginx"> 1、nginx </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/springcloud/springCloud" class="nav-link" aria-label="2、springcloud"> 2、springcloud </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/springcloud/springCloudAlibaba" class="nav-link" aria-label="3、springcloudAlibaba"> 3、springcloudAlibaba </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/distribute/elk/elk1" class="nav-link" aria-label="4、elk1"> 4、elk1 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/distribute/elk/elk2" class="nav-link" aria-label="5、elk2"> 5、elk2 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/distribute/rocketmq/" class="nav-link" aria-label="6、rocketmq"> 6、rocketmq </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="7、rabbitmq" aria-current="page"> 7、rabbitmq </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/docker/" class="nav-link" aria-label="8、docker"> 8、docker </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="项目篇"><span class="title">项目篇</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="项目篇"><span class="title">项目篇</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/project/message/" class="nav-link" aria-label="1、短信调度"> 1、短信调度 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/" class="nav-link" aria-label="2、二奢交易网-上"> 2、二奢交易网-上 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/" class="nav-link" aria-label="2、二奢交易网-中"> 2、二奢交易网-中 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/" class="nav-link" aria-label="2、二奢交易网-下"> 2、二奢交易网-下 </a></li></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="算法篇"><span class="title">算法篇</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="算法篇"><span class="title">算法篇</span><span class="right arrow"></span></button><ul class="nav-dropdown" style="display: none;"><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/algorithm/sort" class="nav-link" aria-label="1、排序"> 1、排序 </a></li><li class="dropdown-item"><a href="https://www.ydlclass.com/doc21xnv/algorithm/base" class="nav-link" aria-label="2、必会算法"> 2、必会算法 </a></li></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><p class="sidebar-heading sidebar-item active">RabbitMQ入门</p><ul class=""><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%A6%82%E8%BF%B0-%E4%BA%86%E8%A7%A3" class="router-link-active router-link-exact-active nav-link sidebar-item active" aria-label="第一章 消息中间件概述-了解"> 第一章 消息中间件概述-了解 </a><ul class="sidebar-sub-items"><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81-%E4%BB%80%E4%B9%88%E6%98%AF%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1、 什么是消息中间件"> 1、 什么是消息中间件 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81amqp-%E5%92%8C-jms" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2、AMQP 和 JMS"> 2、AMQP 和 JMS </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%BA%A7%E5%93%81" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3、消息队列产品"> 3、消息队列产品 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81-rabbitmq" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="4、 RabbitMQ"> 4、 RabbitMQ </a><!----></li></ul></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%BA%8C%E7%AB%A0-rabbitmq%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-%E9%87%8D%E7%82%B9" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="第二章 RabbitMQ工作原理--重点！"> 第二章 RabbitMQ工作原理--重点！ </a><ul class="sidebar-sub-items"><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1、相关概念介绍"> 1、相关概念介绍 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81rabbitmq%E8%BF%90%E8%BD%AC%E6%B5%81%E7%A8%8B" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2、RabbitMQ运转流程"> 2、RabbitMQ运转流程 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85%E6%B5%81%E8%BD%AC%E8%BF%87%E7%A8%8B%E8%AF%B4%E6%98%8E" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3、生产者流转过程说明"> 3、生产者流转过程说明 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E6%B5%81%E8%BD%AC%E8%BF%87%E7%A8%8B%E8%AF%B4%E6%98%8E" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="4、消费者流转过程说明"> 4、消费者流转过程说明 </a><!----></li></ul></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AErabbitmq" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="第三章 安装及配置RabbitMQ"> 第三章 安装及配置RabbitMQ </a><ul class="sidebar-sub-items"><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1、下载安装"> 1、下载安装 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81%E4%B8%8B%E8%BD%BDerlang" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2、下载erlang"> 2、下载erlang </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E5%AE%89%E8%A3%85rabbitmq" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3、安装RabbitMQ"> 3、安装RabbitMQ </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81%E5%90%AF%E5%8A%A8" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="4、启动"> 4、启动 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5%E3%80%81%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F-%E7%99%BB%E5%BD%95rabbitmq" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="5、启动成功 登录RabbitMQ"> 5、启动成功 登录RabbitMQ </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_6%E3%80%81%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="6、注意事项"> 6、注意事项 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_7%E3%80%81%E6%9F%A5%E7%9C%8B%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%8F%B0" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="7、查看管理控制台"> 7、查看管理控制台 </a><!----></li></ul></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E5%9B%9B%E7%AB%A0-rabbitmq%E5%85%A5%E9%97%A8" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="第四章 RabbitMQ入门"> 第四章 RabbitMQ入门 </a><ul class="sidebar-sub-items"><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E6%90%AD%E5%BB%BA%E7%A4%BA%E4%BE%8B%E5%B7%A5%E7%A8%8B" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1、搭建示例工程"> 1、搭建示例工程 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81-%E7%BC%96%E5%86%99%E7%94%9F%E4%BA%A7%E8%80%85" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2、 编写生产者"> 2、 编写生产者 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81-%E7%BC%96%E5%86%99%E6%B6%88%E8%B4%B9%E8%80%85" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3、 编写消费者"> 3、 编写消费者 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81%E5%B0%8F%E7%BB%93" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="4、小结"> 4、小结 </a><!----></li></ul></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%BA%94%E7%AB%A0-rabbitmq%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F-%E9%87%8D%E7%82%B9" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="第五章 RabbitMQ工作模式--重点"> 第五章 RabbitMQ工作模式--重点 </a><ul class="sidebar-sub-items"><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81work-queues%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F-%E5%8C%85%E5%B7%A5%E5%A4%B4" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1、Work queues工作队列模式（包工头）"> 1、Work queues工作队列模式（包工头） </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E6%B5%8B%E8%AF%95" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="（3）测试"> （3）测试 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81publish-subscribe-%E8%AE%A2%E9%98%85%E5%8F%91%E5%B8%83%E6%A8%A1%E5%BC%8F%E7%B1%BB%E5%9E%8B-%E5%BE%AE%E5%8D%9A" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2、publish/subscribe 订阅发布模式类型（微博）"> 2、publish/subscribe 订阅发布模式类型（微博） </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81-publish-subscribe%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-%E5%BE%AE%E5%8D%9A" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3、 Publish/Subscribe发布与订阅模式（微博）"> 3、 Publish/Subscribe发布与订阅模式（微博） </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81routing%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="4、Routing路由模式（分布式日志收集系统）"> 4、Routing路由模式（分布式日志收集系统） </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5%E3%80%81-topics%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="5、 Topics通配符模式"> 5、 Topics通配符模式 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_6%E3%80%81-%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="6、 模式总结"> 6、 模式总结 </a><!----></li></ul></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E5%85%AD%E7%AB%A0-spring-%E6%95%B4%E5%90%88rabbitmq-%E4%BA%86%E8%A7%A3" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="第六章 Spring 整合RabbitMQ-了解"> 第六章 Spring 整合RabbitMQ-了解 </a><ul class="sidebar-sub-items"><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E7%A8%8B" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1、搭建生产者工程"> 1、搭建生产者工程 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81%E6%90%AD%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E5%B7%A5%E7%A8%8B" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2、搭建消费者工程"> 2、搭建消费者工程 </a><!----></li></ul></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%B8%83%E7%AB%A0-spring-boot%E6%95%B4%E5%90%88rabbitmq" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="第七章 Spring Boot整合RabbitMQ"> 第七章 Spring Boot整合RabbitMQ </a><ul class="sidebar-sub-items"><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81-%E7%AE%80%E4%BB%8B" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1、 简介"> 1、 简介 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E7%A8%8B" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2、搭建生产者工程"> 2、搭建生产者工程 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E6%90%AD%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E5%B7%A5%E7%A8%8B" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3、搭建消费者工程"> 3、搭建消费者工程 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81-%E6%B5%8B%E8%AF%95" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="4、 测试"> 4、 测试 </a><!----></li></ul></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%B8%80%E7%AB%A0-rabbitmq-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="第一章 RabbitMQ 高级特性"> 第一章 RabbitMQ 高级特性 </a><ul class="sidebar-sub-items"><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1、消息可靠性投递"> 1、消息可靠性投递 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81consumer-ack" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2、Consumer ACK"> 2、Consumer ACK </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%99%90%E6%B5%81" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3、消费端限流"> 3、消费端限流 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81ttl" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="4、TTL"> 4、TTL </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5%E3%80%81%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="5、死信队列"> 5、死信队列 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_6%E3%80%81%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97-%E9%87%8D%E7%82%B9" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="6、延迟队列-重点"> 6、延迟队列-重点 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_7%E3%80%81%E6%97%A5%E5%BF%97%E4%B8%8E%E7%9B%91%E6%8E%A7-%E4%BA%86%E8%A7%A3" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="7、日志与监控-了解"> 7、日志与监控-了解 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_8%E3%80%81%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA-%E4%BA%86%E8%A7%A3" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="8、消息追踪-了解"> 8、消息追踪-了解 </a><!----></li></ul></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%BA%8C%E7%AB%A0-rabbitmq%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98-%E9%9D%A2%E8%AF%95" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="第二章 RabbitMQ应用问题-面试"> 第二章 RabbitMQ应用问题-面试 </a><ul class="sidebar-sub-items"><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BF%9D%E9%9A%9C" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1、消息可靠性保障"> 1、消息可靠性保障 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81-%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7%E5%A4%84%E7%90%86" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2、 消息幂等性处理"> 2、 消息幂等性处理 </a><!----></li><li><a aria-current="page" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81rabbitmq%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-%E8%BF%90%E7%BB%B4" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3、RabbitMQ集群搭建-运维"> 3、RabbitMQ集群搭建-运维 </a><!----></li></ul></li></ul><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><div class="theme-default-content"><h1 id="rabbitmq入门" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#rabbitmq%E5%85%A5%E9%97%A8" aria-hidden="true">#</a> RabbitMQ入门</h1><p>学习目标</p><ul><li>能够说出什么是消息中间件</li><li>能够安装RabbitMQ</li><li>能够编写RabbitMQ的入门程序</li><li>能够说出RabbitMQ的5种模式特征-重点</li><li>能够使用Spring整合RabbitMQ</li></ul><h2 id="第一章-消息中间件概述-了解" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%A6%82%E8%BF%B0-%E4%BA%86%E8%A7%A3" aria-hidden="true">#</a> 第一章 消息中间件概述-了解</h2><h3 id="_1、-什么是消息中间件" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81-%E4%BB%80%E4%B9%88%E6%98%AF%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6" aria-hidden="true">#</a> 1、 什么是消息中间件</h3><h4 id="_1-mq是什么" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-mq%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true">#</a> （1）MQ是什么</h4><p>MQ全称为Message Queue，消息队列是应用程序和应用程序之间的通信方法。</p><p>先进先出</p><p>原先：ip:port/order/add?goodsId=1</p><p><img src="./RabbitMQ_files/image-20220408204615842.7d54a462.png" alt="image-20220408204615842" class="medium-zoom-image"></p><p>现在：异步调用</p><p><img src="./RabbitMQ_files/image-20220408205148101.8e02d37e.png" alt="image-20220408205148101" class="medium-zoom-image"></p><h4 id="_2-为什么使用mq-面试" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8mq-%E9%9D%A2%E8%AF%95" aria-hidden="true">#</a> （2）为什么使用MQ--面试</h4><p>在项目中，可将一些无需即时返回且耗时的操作提取出来，进行<strong>异步处理</strong>，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而<strong>提高</strong>了<strong>系统</strong>的<strong>吞吐量</strong>。</p><p>现在，应用开发和部署---微服务。</p><h4 id="_3-mq优势" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-mq%E4%BC%98%E5%8A%BF" aria-hidden="true">#</a> <strong>（3）MQ优势</strong></h4><h5 id="a、应用解耦" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#a%E3%80%81%E5%BA%94%E7%94%A8%E8%A7%A3%E8%80%A6" aria-hidden="true">#</a> a、<strong>应用解耦</strong></h5><p>MQ相当于一个中介，生产方通过MQ与消费方交互，它将应用程序进行解耦合。</p><p><img src="./RabbitMQ_files/image-20220408210051290.62f0af15.png" alt="image-20220408210051290" class="medium-zoom-image"></p><h5 id="b、异步提速" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#b%E3%80%81%E5%BC%82%E6%AD%A5%E6%8F%90%E9%80%9F" aria-hidden="true">#</a> b、<strong>异步提速</strong></h5><p>将不需要同步处理的并且耗时长的操作由消息队列通知消息接收方进行异步处理。提高了应用程序的响应时间。</p><p><img src="./RabbitMQ_files/image-20220408210805836.e96c44ed.png" alt="image-20220408210805836" class="medium-zoom-image"></p><p>order_table status 0 已下单 status 1 支付成功 status 2 已通知商家发货 status 3 商家发货 status 4 已经收货</p><h5 id="c、削峰填谷" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#c%E3%80%81%E5%89%8A%E5%B3%B0%E5%A1%AB%E8%B0%B7" aria-hidden="true">#</a> c、<strong>削峰填谷</strong></h5><p>如订单系统，在下单的时候就会往数据库写数据。但是数据库只能支撑每秒1000左右的并发写入，并发量再高就容易宕机。低峰期的时候并发也就100多个，但是在高峰期时候，并发量会突然激增到5000以上，这个时候数据库肯定卡死了。</p><p>消息被MQ保存起来了，然后系统就可以按照自己的消费能力来消费，比如每秒1000个数据，这样慢慢写入数据库，这样就不会卡死数据库了。</p><p><img src="./RabbitMQ_files/image-20220408211341420.d3b8bb87.png" alt="image-20220408211341420" class="medium-zoom-image"></p><p>但是使用了MQ之后，限制消费消息的速度为1000，但是这样一来，高峰期产生的数据势必会被积压在MQ中，高峰就被“削”掉了。但是因为消息积压，在高峰期过后的一段时间内，消费消息的速度还是会维持在1000QPS，直到消费完积压的消息,这就叫做“填谷”</p><p><img src="./RabbitMQ_files/03.2066487d.jpg" alt="" class="medium-zoom-image"></p><h4 id="_4-mq劣势" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-mq%E5%8A%A3%E5%8A%BF" aria-hidden="true">#</a> （4）<strong>MQ劣势</strong></h4><ul><li><strong>系统可用性降低</strong></li></ul><p>系统引入的外部依赖越多，系统稳定性越差。一旦 MQ 宕机，就会对业务造成影响。如何保证MQ的高可用？</p><ul><li><strong>系统复杂度提高</strong></li></ul><p>MQ 的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过 MQ 进行异步调用。如何</p><p>保证消息没有被重复消费？怎么处理消息丢失情况？那么保证消息传递的顺序性？</p><ul><li><strong>一致性问题</strong></li></ul><p>A 系统处理完业务，通过 MQ 给B、C、D三个系统发消息数据，如果 B 系统、C 系统处理成功，D 系统处理</p><p>失败。如何保证消息数据处理的一致性。</p><p>最终一致性。</p><h4 id="_5-什么时候用mq" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8mq" aria-hidden="true">#</a> （5）什么时候用MQ</h4><p>① 生产者不需要从消费者处获得反馈。引入消息队列之前的直接调用，其接口的返回值应该为空，这才让明 明下层的动作还没做，上层却当成动作做完了继续往后走，即所谓异步成为了可能。</p><p>② 容许短暂的不一致性。</p><p>③ 确实是用了有效果。即解耦、提速、削峰这些方面的收益，超过加入MQ，管理MQ这些成本、</p><h3 id="_2、amqp-和-jms" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81amqp-%E5%92%8C-jms" aria-hidden="true">#</a> 2、AMQP 和 JMS</h3><p>MQ是消息通信的模型；实现MQ的大致有两种主流方式：AMQP、JMS。</p><h4 id="_1-amqp" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-amqp" aria-hidden="true">#</a> （1）AMQP</h4><p>AMQP是一种协议，更准确的说是一种binary wire-level protocol（链接协议）。这是其和JMS的本质差别，AMQP不从API层进行限定，而是直接定义网络交换的数据格式。</p><h4 id="_2-jms" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-jms" aria-hidden="true">#</a> （2）JMS</h4><p>JMS即Java消息服务（JavaMessage Service）应用程序接口，是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。</p><h4 id="_3-amqp-与-jms-区别" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-amqp-%E4%B8%8E-jms-%E5%8C%BA%E5%88%AB" aria-hidden="true">#</a> （3）AMQP 与 JMS 区别</h4><ul><li>JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过规定协议来统一数据交互的格式</li><li>JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。</li><li>JMS规定了两种消息模式；而AMQP的消息模式更加丰富。</li></ul><h3 id="_3、消息队列产品" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%BA%A7%E5%93%81" aria-hidden="true">#</a> 3、消息队列产品</h3><p>市场上常见的消息队列有如下：</p><ul><li>ActiveMQ：基于JMS</li><li>ZeroMQ：基于C语言开发</li><li>RabbitMQ：基于AMQP协议，erlang语言开发，稳定性好</li><li>RocketMQ：基于JMS，阿里巴巴产品</li><li>Kafka：类似MQ的产品；分布式消息系统，高吞吐量</li></ul><p><img src="./RabbitMQ_files/image-20200320111345727.041941a7.png" alt="image-20200320111345727" class="medium-zoom-image"></p><h3 id="_4、-rabbitmq" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81-rabbitmq" aria-hidden="true">#</a> 4、 RabbitMQ</h3><h4 id="_1-rabbitmq特点" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-rabbitmq%E7%89%B9%E7%82%B9" aria-hidden="true">#</a> （1）RabbitMQ<strong>特点</strong>：</h4><ul><li>1、使用简单，功能强大。</li><li>2、基于<strong>AMQP</strong>协议。 跨语言 c node.js-&gt;mq-&gt;java python</li><li>3、社区活跃，文档完善。</li><li>4、高并发性能好，这主要得益于<strong>Erlang</strong>语言。 c 底层语言，性能强。java 好开发。构建一个web。</li><li>5、Spring Boot默认已集成RabbitMQ</li></ul><h4 id="_2-其它相关术语" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E5%85%B6%E5%AE%83%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD" aria-hidden="true">#</a> （2）其它相关术语</h4><p>AMQP：</p><p><img src="./RabbitMQ_files/image-20200320174327969.9152399e.png" alt="image-20200320174327969" class="medium-zoom-image"></p><p>JMS ：</p><p><img src="./RabbitMQ_files/image-20200320174346261.ff48f62e.png" alt="image-20200320174346261" class="medium-zoom-image"></p><p>总结：</p><p>JMS是java提供的一套消息服务API标准，其目的是为所有的java应用程序提供统一的消息通信的标准，类似java的jdbc，只要遵循jms标准的应用程序之间都可以进行消息通信。</p><p>它和AMQP有什么 不同，jms是java语言专属的消息服务标准，它是在api层定义标准，并且只能用于java应用；而AMQP是在协议层定义的标准，是跨语言的 。</p><h4 id="_3-工作模式" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F" aria-hidden="true">#</a> （3）工作模式</h4><p>RabbitMQ提供了6种模式：简单模式，work模式，Publish/Subscribe发布与订阅模式，<strong>Routing</strong>路由模式，<strong>Topics</strong>主题模式，RPC远程调用模式（远程调用，不太算MQ；暂不作介绍）；</p><p>官网对应模式介绍：https://www.rabbitmq.com/getstarted.html</p><p><img src="./RabbitMQ_files/1555988678324.a0be1434.png" alt="1555988678324" class="medium-zoom-image"></p><h2 id="第二章-rabbitmq工作原理-重点" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%BA%8C%E7%AB%A0-rabbitmq%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-%E9%87%8D%E7%82%B9" aria-hidden="true">#</a> 第二章 RabbitMQ工作原理--重点！</h2><p><strong>重点看这张图</strong>：</p><p><img src="./RabbitMQ_files/image-20200320180217097.84d99cd3.png" alt="image-20200320180217097" class="medium-zoom-image"></p><p>http 三次握手 四次挥手 一个长连接</p><p><strong>一个消费者监听“一个”“队列”</strong></p><ul><li>Broker：消息队列服务进程，此进程包括两个部分：Exchange和Queue。</li><li>Exchange：消息队列交换机，按一定的规则将消息路由转发到某个队列，对消息进行过虑。</li><li>Queue：消息队列，存储消息的队列，消息到达队列并转发给指定的消费方。</li><li>Producer：消息生产者，即生产方客户端，生产方客户端将消息发送到MQ。</li><li>Consumer：消息消费者，即消费方客户端，接收MQ转发的消息。</li></ul><p>消息发布接收流程：</p><p>-----发送消息-----</p><p>1、生产者和Broker建立TCP连接。</p><p>2、生产者和Broker建立通道。</p><p>3、生产者通过通道消息发送给Broker，由Exchange将消息进行转发。</p><p>4、Exchange将消息转发到指定的Queue（队列）</p><p>----接收消息-----</p><p>1、消费者和Broker建立TCP连接</p><p>2、消费者和Broker建立通道</p><p>3、消费者监听指定的Queue（队列）</p><p>4、当有消息到达Queue时Broker默认将消息推送给消费者。</p><p>5、消费者接收到消息。</p><h3 id="_1、相关概念介绍" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D" aria-hidden="true">#</a> 1、相关概念介绍</h3><p>AMQP 一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。</p><p>AMQP是一个二进制协议，拥有一些现代化特点：多信道、协商式，异步，安全，扩平台，中立，高效。</p><p>RabbitMQ是AMQP协议的Erlang的实现。</p><table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>连接Connection</td><td>一个网络连接，比如TCP/IP套接字连接。</td></tr><tr><td>会话Session</td><td>端点之间的命名对话。在一个会话上下文中，保证“恰好传递一次”。</td></tr><tr><td>信道Channel</td><td>多路复用连接中的一条独立的双向数据流通道。为会话提供物理传输介质。</td></tr><tr><td>客户端Client</td><td>AMQP连接或者会话的发起者。AMQP是非对称的，客户端生产和消费消息，服务器存储和路由这些消息。</td></tr><tr><td>服务节点Broker</td><td>消息中间件的服务节点；一般情况下可以将一个RabbitMQ Broker看作一台RabbitMQ 服务器。</td></tr><tr><td>端点</td><td>AMQP对话的任意一方。一个AMQP连接包括两个端点（一个是客户端，一个是服务器）。</td></tr><tr><td>消费者Consumer</td><td>一个从消息队列里请求消息的客户端程序。</td></tr><tr><td>生产者Producer</td><td>一个向交换机发布消息的客户端应用程序。</td></tr></tbody></table><h3 id="_2、rabbitmq运转流程" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81rabbitmq%E8%BF%90%E8%BD%AC%E6%B5%81%E7%A8%8B" aria-hidden="true">#</a> 2、RabbitMQ运转流程</h3><p>在入门案例中：</p><ul><li>生产者发送消息 <ol><li>生产者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker；</li><li>声明队列并设置属性；如是否排它，是否持久化，是否自动删除；</li><li>将路由键（空字符串）与队列绑定起来；</li><li>发送消息至RabbitMQ Broker；</li><li>关闭信道；</li><li>关闭连接；</li></ol></li><li>消费者接收消息 <ol><li>消费者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker</li><li>向Broker 请求消费相应队列中的消息，设置相应的回调函数；</li><li>等待Broker回应闭关投递响应队列中的消息，消费者接收消息；</li><li>确认（ack，自动确认）接收到的消息；</li><li>RabbitMQ从队列中删除相应已经被确认的消息；</li><li>关闭信道；</li><li>关闭连接；</li></ol></li></ul><p><img src="./RabbitMQ_files/1565105223969.976e339d.png" alt="1565105223969" class="medium-zoom-image"></p><h3 id="_3、生产者流转过程说明" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85%E6%B5%81%E8%BD%AC%E8%BF%87%E7%A8%8B%E8%AF%B4%E6%98%8E" aria-hidden="true">#</a> 3、生产者流转过程说明</h3><ol><li>客户端与代理服务器Broker建立连接。会调用newConnection() 方法,这个方法会进一步封装Protocol Header 0-9-1 的报文头发送给Broker ，以此通知Broker 本次交互采用的是AMQPO-9-1 协议，紧接着Broker 返回Connection.Start 来建立连接，在连接的过程中涉及Connection.Start/.Start-OK 、Connection.Tune/.Tune-Ok ，Connection.Open/ .Open-Ok 这6 个命令的交互。</li><li>客户端调用connection.createChannel方法。此方法开启信道，其包装的channel.open命令发送给Broker,等待channel.basicPublish方法，对应的AMQP命令为Basic.Publish,这个命令包含了content Header 和content Body()。content Header 包含了消息体的属性，例如:投递模式，优先级等，content Body 包含了消息体本身。</li><li>客户端发送完消息需要关闭资源时，涉及到Channel.Close和Channl.Close-Ok 与Connetion.Close和Connection.Close-Ok的命令交互。</li></ol><h3 id="_4、消费者流转过程说明" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E6%B5%81%E8%BD%AC%E8%BF%87%E7%A8%8B%E8%AF%B4%E6%98%8E" aria-hidden="true">#</a> 4、消费者流转过程说明</h3><ol><li>消费者客户端与代理服务器Broker建立连接。会调用newConnection() 方法,这个方法会进一步封装Protocol Header 0-9-1 的报文头发送给Broker ，以此通知Broker 本次交互采用的是AMQPO-9-1 协议，紧接着Broker 返回Connection.Start 来建立连接，在连接的过程中涉及Connection.Start/.Start-OK 、Connection.Tune/.Tune-Ok ，Connection.Open/ .Open-Ok 这6 个命令的交互。</li><li>消费者客户端调用connection.createChannel方法。和生产者客户端一样，协议涉及Channel . Open/Open-Ok命令。</li><li>在真正消费之前，消费者客户端需要向Broker 发送Basic.Consume 命令(即调用channel.basicConsume 方法〉将Channel 置为接收模式，之后Broker 回执Basic . Consume - Ok 以告诉消费者客户端准备好消费消息。</li><li>Broker 向消费者客户端推送(Push) 消息，即Basic.Deliver 命令，这个命令和Basic.Publish 命令一样会携带Content Header 和Content Body。</li><li>消费者接收到消息并正确消费之后，向Broker 发送确认，即Basic.Ack 命令。</li><li>客户端发送完消息需要关闭资源时，涉及到Channel.Close和Channl.Close-Ok 与Connetion.Close和Connection.Close-Ok的命令交互。</li></ol><h2 id="第三章-安装及配置rabbitmq" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AErabbitmq" aria-hidden="true">#</a> 第三章 安装及配置RabbitMQ</h2><h3 id="_1、下载安装" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85" aria-hidden="true">#</a> 1、下载安装</h3><p>​ RabbitMQ由Erlang语言开发，Erlang语言用于并发及分布式系统的开发，在电信领域应用广泛，OTP（Open Telecom Platform）作为Erlang语言的一部分，包含了很多基于Erlang开发的中间件及工具库，安装RabbitMQ需要安装Erlang/OTP，并保持版本匹配，如下图：</p><p>RabbitMQ的下载地址：http://www.rabbitmq.com/download.html</p><p><img src="./RabbitMQ_files/image-20220408215304890.e1f46c2f.png" alt="image-20220408215304890" class="medium-zoom-image"></p><p>本项目使用Erlang/OTP 20.3版本和RabbitMQ3.7.3版本。</p><h3 id="_2、下载erlang" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81%E4%B8%8B%E8%BD%BDerlang" aria-hidden="true">#</a> 2、下载erlang</h3><p>安装软件：路径不要有中文和空格。<strong>管理员</strong></p><p>1地址如下：</p><p>https://www.erlang.org/downloads</p><p>或去老师提供的软件包中找到 otp_win64_20.3.exe，以<strong>管理员</strong>方式运行此文件，安装。</p><p>2erlang安装完成需要配置erlang环境变量：</p><p>​ ERLANG_HOME=D:\soft\erl9.3</p><p>​ 在path中添加%ERLANG_HOME%\bin</p><h3 id="_3、安装rabbitmq" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E5%AE%89%E8%A3%85rabbitmq" aria-hidden="true">#</a> 3、安装RabbitMQ</h3><p>https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.7.3</p><p>或去老师提供的软件包中找到 rabbitmq-server-3.7.3.exe，以<strong>管理员</strong>方式运行此文件，安装。</p><p><img src="./RabbitMQ_files/image-20220408220632620.dcd30a93.png" alt="image-20220408220632620" class="medium-zoom-image"></p><h3 id="_4、启动" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81%E5%90%AF%E5%8A%A8" aria-hidden="true">#</a> 4、启动</h3><p>安装成功后会自动创建RabbitMQ服务并且启动。</p><p>（1）从开始菜单启动RabbitMQ</p><p>完成在开始菜单找到RabbitMQ的菜单：</p><p><img src="./RabbitMQ_files/image-20200320174855134.7aa6274f.png" alt="image-20200320174855134" class="medium-zoom-image"></p><p>RabbitMQ Service-install :安装服务</p><p>RabbitMQ Service-remove 删除服务</p><p>RabbitMQ Service-start 启动</p><p>RabbitMQ Service-stop 启动</p><p>（2）如果没有开始菜单则进入安装目录下sbin目录手动启动：</p><p><img src="./RabbitMQ_files/image-20200320174919367.09c74d6b.png" alt="image-20200320174919367" class="medium-zoom-image"></p><p>（3）安装并运行服务</p><p>rabbitmq-service.bat install 安装服务</p><p>rabbitmq-service.bat stop 停止服务</p><p>rabbitmq-service.bat start 启动服务</p><p>（4）安装管理插件</p><p>安装rabbitMQ的管理插件，方便在浏览器端管理RabbitMQ</p><p>在sbin目录下，<strong>管理员身份</strong>运行cmd</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rabbitmq-plugins.bat enable rabbitmq_management
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="_5、启动成功-登录rabbitmq" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5%E3%80%81%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F-%E7%99%BB%E5%BD%95rabbitmq" aria-hidden="true">#</a> 5、启动成功 登录RabbitMQ</h3><p>进入浏览器，输入：http://localhost:15672</p><p><img src="./RabbitMQ_files/image-20200320175052306.a9c088c5.png" alt="image-20200320175052306" class="medium-zoom-image"></p><p>初始账号和密码：guest/guest</p><p><img src="./RabbitMQ_files/image-20220408221008693.bd953c3f.png" alt="image-20220408221008693" class="medium-zoom-image"></p><h3 id="_6、注意事项" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_6%E3%80%81%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" aria-hidden="true">#</a> 6、注意事项</h3><p>1、安装erlang和rabbitMQ以管理员身份运行。</p><p>2、当卸载重新安装时会出现RabbitMQ服务注册失败，此时需要进入注册表清理erlang</p><p>搜索RabbitMQ、ErlSrv，将对应的项全部删除。</p><h3 id="_7、查看管理控制台" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_7%E3%80%81%E6%9F%A5%E7%9C%8B%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%8F%B0" aria-hidden="true">#</a> 7、查看管理控制台</h3><p><img src="./RabbitMQ_files/image-20200320175339750.e00ee8bc.png" alt="image-20200320175339750" class="medium-zoom-image"></p><p>尝试新增用户、新增虚拟机。</p><h2 id="第四章-rabbitmq入门" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E5%9B%9B%E7%AB%A0-rabbitmq%E5%85%A5%E9%97%A8" aria-hidden="true">#</a> 第四章 RabbitMQ入门</h2><p><strong>简单模式</strong></p><p><img src="./RabbitMQ_files/image-20200320180411894.bbf971ee.png" alt="image-20200320180411894" class="medium-zoom-image"></p><h3 id="_1、搭建示例工程" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E6%90%AD%E5%BB%BA%E7%A4%BA%E4%BE%8B%E5%B7%A5%E7%A8%8B" aria-hidden="true">#</a> 1、搭建示例工程</h3><h4 id="_1-创建工程" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B" aria-hidden="true">#</a> （1）创建工程</h4><p><img src="./RabbitMQ_files/image-20220408221608751.f881d76e.png" alt="image-20220408221608751" class="medium-zoom-image"></p><p>rabbitmqtest父工程下，新建两个模块：producer和consumer</p><p><img src="./RabbitMQ_files/image-20220408221703947.3fefbc02.png" alt="image-20220408221703947" class="medium-zoom-image"></p><h4 id="_2-添加依赖" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96" aria-hidden="true">#</a> （2）添加依赖</h4><p>往rabbitmqtest的pom.xml文件中添加如下依赖：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.rabbitmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>amqp-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.6.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_2、-编写生产者" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81-%E7%BC%96%E5%86%99%E7%94%9F%E4%BA%A7%E8%80%85" aria-hidden="true">#</a> 2、 编写生产者</h3><p>producer工程中，编写消息生产者com.ydlclass.rabbitmq.simple.Producer</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>simple</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span>AMQP<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的ip</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的端口</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置虚拟主机</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置用户名</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置密码</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建长连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3创建channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//声明队列</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">"ydlqueue"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4发消息</span>
        <span class="token comment">// String exchange,  交换机</span>
        <span class="token comment">// String routingKey, 路由键</span>
        <span class="token comment">// AMQP.BasicProperties props, 属性</span>
        <span class="token comment">// byte[] body 消息      string byte[] char[]如何相互转换的？</span>
        <span class="token class-name">String</span> msg<span class="token operator">=</span><span class="token string">"hello rabbitmq!"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"ydlqueue"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5关闭连接  资源关闭的顺序，先关后出来的资源，最后关，第一个资源</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>在执行上述的消息发送之后；可以登录rabbitMQ的管理控制台，可以发现队列和其消息：</p><p><img src="./RabbitMQ_files/image-20220408223540630.119923ff.png" alt="image-20220408223540630" class="medium-zoom-image"></p><p>查看消息</p><p><img src="./RabbitMQ_files/image-20220408223601408.a29a49a6.png" alt="image-20220408223601408" class="medium-zoom-image"></p><p><strong>注意</strong>：关闭连接</p><h3 id="_3、-编写消费者" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81-%E7%BC%96%E5%86%99%E6%B6%88%E8%B4%B9%E8%80%85" aria-hidden="true">#</a> 3、 编写消费者</h3><p>consumer工程，编写消息的消费者com.ydlclass.rabbitmq.simple.Consumer</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>simple</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ConnectionUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"simple_queue"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//主机地址;默认为 localhost</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接端口;默认为 5672</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//虚拟主机名称;默认为 /</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接用户名；默认为guest</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接密码；默认为guest</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3创建频道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//6声明（创建）队列</span>
        <span class="token doc-comment comment">/**
         * 参数1：队列名称
         * 参数2：是否定义持久化队列
         * 参数3：是否独占本次连接
         * 参数4：是否在不使用的时候自动删除队列
         * 参数5：队列其它参数
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5创建消费者；并设置消息处理</span>
        <span class="token class-name">DefaultConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token doc-comment comment">/**
             * consumerTag 消息者标签，在channel.basicConsume时候可以指定
             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)
             * properties 属性信息
             * body 消息
             */</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token comment">//消费者标签</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者标签为："</span> <span class="token operator">+</span> consumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//路由key</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"路由key为："</span> <span class="token operator">+</span> envelope<span class="token punctuation">.</span><span class="token function">getRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//交换机</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"交换机为："</span> <span class="token operator">+</span> envelope<span class="token punctuation">.</span><span class="token function">getExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//消息id</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息id为："</span> <span class="token operator">+</span> envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//收到的消息</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到的消息为："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//4监听消息</span>
        <span class="token doc-comment comment">/**
         * 参数1：队列名称
         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认
         * 参数3：消息接收到后回调
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//不关闭资源，应该一直监听消息</span>
        <span class="token comment">//channel.close();</span>
        <span class="token comment">//connection.close();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p><strong>有能力的同学</strong>，抽取创建connection的工具类com.ydlclass.rabbitmq.util.ConnectionUtil；</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//主机地址;默认为 localhost</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接端口;默认为 5672</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//虚拟主机名称;默认为 /</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接用户名；默认为guest</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接密码；默认为guest</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//创建连接</span>
        <span class="token keyword">return</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_4、小结" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81%E5%B0%8F%E7%BB%93" aria-hidden="true">#</a> 4、小结</h3><p>上述的入门案例中中其实使用的是如下的简单模式：</p><p><img src="./RabbitMQ_files/1555991074575.c86a7dcf.png" alt="1555991074575" class="medium-zoom-image"></p><p>在上图的模型中，有以下概念：</p><ul><li>P：生产者，也就是要发送消息的程序</li><li>C：消费者：消息的接受者，会一直等待消息到来。</li><li>queue：消息队列，图中红色部分。类似一个邮箱，可以缓存消息；生产者向其中投递消息，消费者从其中取出消息。</li></ul><h2 id="第五章-rabbitmq工作模式-重点" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%BA%94%E7%AB%A0-rabbitmq%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F-%E9%87%8D%E7%82%B9" aria-hidden="true">#</a> 第五章 RabbitMQ工作模式--重点</h2><h3 id="_1、work-queues工作队列模式-包工头" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81work-queues%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F-%E5%8C%85%E5%B7%A5%E5%A4%B4" aria-hidden="true">#</a> 1、Work queues工作队列模式（包工头）</h3><h4 id="_1-模式说明" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E" aria-hidden="true">#</a> （1） 模式说明</h4><p><img src="./RabbitMQ_files/1556009144848.1e306c6c.png" alt="1556009144848" class="medium-zoom-image"></p><p><code>Work Queues</code>与入门程序的<code>简单模式</code>相比，多了一个或一些消费端，多个消费端共同消费同一个队列中的消息。</p><p><strong>应用场景</strong>：对于 任务过重或任务较多情况使用工作队列可以提高任务处理的速度。</p><h4 id="_2-代码" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E4%BB%A3%E7%A0%81" aria-hidden="true">#</a> （2）代码</h4><p>复制生产者消费者各一份</p><p><img src="./RabbitMQ_files/image-20220411210359456.c4ca6df9.png" alt="image-20220411210359456" class="medium-zoom-image"></p><h5 id="a、生产者-修改队列名" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#a%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85-%E4%BF%AE%E6%94%B9%E9%98%9F%E5%88%97%E5%90%8D" aria-hidden="true">#</a> a、生产者 修改队列名</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"workqueue"</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg<span class="token operator">=</span><span class="token string">"hello rabbitmq!workqueue"</span><span class="token operator">+</span>i<span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span>QUEUE<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="b、消费者1-监听同一个队列" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#b%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%851-%E7%9B%91%E5%90%AC%E5%90%8C%E4%B8%80%E4%B8%AA%E9%98%9F%E5%88%97" aria-hidden="true">#</a> b、消费者1 监听同一个队列</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"workqueue"</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h5 id="c、消费者2-消费者再起一份" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#c%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%852-%E6%B6%88%E8%B4%B9%E8%80%85%E5%86%8D%E8%B5%B7%E4%B8%80%E4%BB%BD" aria-hidden="true">#</a> c、消费者2 消费者再起一份</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">"workqueue"</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="_3-测试" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E6%B5%8B%E8%AF%95" aria-hidden="true">#</a> （3）测试</h3><p>生产者，多运行几次，观察连个消费者</p><p>设置，消费者能启多份：</p><p><img src="./RabbitMQ_files/image-20220411210105591.b88f5e92.png" alt="image-20220411210105591" class="medium-zoom-image"></p><p>在一个队列中如果有多个消费者，那么消费者之间对于同一个队列消息的关系是<strong>竞争</strong>的关系。</p><p>第一个消费者</p><p><img src="./RabbitMQ_files/image-20220411210449520.b8782f8d.png" alt="image-20220411210449520" class="medium-zoom-image"></p><p>第二个消费者:</p><p><img src="./RabbitMQ_files/image-20220411210501744.c194803f.png" alt="image-20220411210501744" class="medium-zoom-image"></p><h3 id="_2、publish-subscribe-订阅发布模式类型-微博" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81publish-subscribe-%E8%AE%A2%E9%98%85%E5%8F%91%E5%B8%83%E6%A8%A1%E5%BC%8F%E7%B1%BB%E5%9E%8B-%E5%BE%AE%E5%8D%9A" aria-hidden="true">#</a> 2、publish/subscribe 订阅发布模式类型（微博）</h3><p>atm取100元，短信，邮件。</p><p>订阅模式示例图：</p><p><img src="./RabbitMQ_files/1556014499573.535fc6ca.png" alt="1556014499573" class="medium-zoom-image"></p><p>前面2个案例中，只有3个角色：</p><ul><li>P：生产者，也就是要发送消息的程序</li><li>C：消费者：消息的接受者，会一直等待消息到来。</li><li>queue：消息队列，图中红色部分</li></ul><p>而在订阅模型中，多了一个exchange角色，而且过程略有变化：</p><ul><li>P：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</li><li>C：消费者，消息的接受者，会一直等待消息到来。</li><li>Queue：消息队列，接收消息、缓存消息。</li><li>Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有常见以下3种类型： <ul><li>Fanout：广播，将消息交给所有绑定到交换机的队列</li><li>Direct：定向，把消息交给符合指定routing key 的队列</li><li>Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列</li></ul></li></ul><p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！</p><h3 id="_3、-publish-subscribe发布与订阅模式-微博" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81-publish-subscribe%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-%E5%BE%AE%E5%8D%9A" aria-hidden="true">#</a> 3、 Publish/Subscribe发布与订阅模式（微博）</h3><h4 id="_1-模式说明-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E-1" aria-hidden="true">#</a> （ 1）模式说明</h4><p><img src="./RabbitMQ_files/1556010329032.4888b21e.png" alt="1556010329032" class="medium-zoom-image"></p><p>发布订阅模式： 1、每个消费者监听自己的队列。 2、生产者将消息发给broker，由交换机将消息转发到绑定此交换机的每个队列，每个绑定交换机的队列都将接收 到消息</p><h4 id="_2-代码-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E4%BB%A3%E7%A0%81-1" aria-hidden="true">#</a> （2）代码</h4><h5 id="a、生产者" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#a%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85" aria-hidden="true">#</a> a、生产者</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>simple</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * creste by ydlclass.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer_pubsub</span> <span class="token punctuation">{</span>
    <span class="token comment">//交换机名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_EXCHAGE <span class="token operator">=</span> <span class="token string">"fanout_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_QUEUE_1 <span class="token operator">=</span> <span class="token string">"fanout_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_QUEUE_2 <span class="token operator">=</span> <span class="token string">"fanout_queue_2"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//主机地址;默认为 localhost</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接端口;默认为 5672</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//虚拟主机名称;默认为 /</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接用户名；默认为guest</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接密码；默认为guest</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3创建频道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * 声明交换机
         * 参数1：交换机名称
         * 参数2：交换机类型，fanout、topic、direct、headers
         * 参数3：是否定义持久化
         * 参数4：是否在不使用的时候自动删除
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>FANOUT_EXCHAGE<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>FANOUT<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明（创建）队列</span>
        <span class="token doc-comment comment">/**
         * 参数1：队列名称
         * 参数2：是否定义持久化队列
         * 参数3：是否独占本次连接
         * 参数4：是否在不使用的时候自动删除队列
         * 参数5：队列其它参数
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//队列绑定交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">,</span> FANOUT_EXCHAGE<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">,</span> FANOUT_EXCHAGE<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 发送信息</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"你好；小兔子！发布订阅模式--"</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            <span class="token doc-comment comment">/**
             * 参数1：交换机名称，如果没有指定则使用默认Default Exchage
             * 参数2：路由key,简单模式可以传递队列名称
             * 参数3：消息其它属性
             * 参数4：消息内容
             */</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>FANOUT_EXCHAGE<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"已发送消息："</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 关闭资源</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><h5 id="b、消费者1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#b%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%851" aria-hidden="true">#</a> b、消费者1</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>publish</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer1</span> <span class="token punctuation">{</span>
    <span class="token comment">//交换机名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_EXCHAGE <span class="token operator">=</span> <span class="token string">"fanout_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_QUEUE_1 <span class="token operator">=</span> <span class="token string">"fanout_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_QUEUE_2 <span class="token operator">=</span> <span class="token string">"fanout_queue_2"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的ip</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的端口</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置虚拟主机</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置用户名</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置密码</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建长连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3创建channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明队列</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明交换机</span>
        <span class="token comment">// String exchange,  交换机名称</span>
        <span class="token comment">// BuiltinExchangeType type, 交换机类型</span>
        <span class="token comment">// boolean durable,  持久化</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>FANOUT_EXCHAGE<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>FANOUT<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//队列绑定交换机</span>
        <span class="token comment">// String queue, 队列名称</span>
        <span class="token comment">// String exchange, 交换机名称</span>
        <span class="token comment">// String routingKey 路由键</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">,</span>FANOUT_EXCHAGE<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">,</span>FANOUT_EXCHAGE<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//4监听某个队列</span>
        <span class="token comment">// String queue, 监听的队列名</span>
        <span class="token comment">// boolean autoAck, 是否自动应答</span>
        <span class="token comment">// Consumer callback 回调函数，收到消息，我要干啥</span>
        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span>Consumer</span> consumer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 回调函数，收到消息，我要干啥</span>
            <span class="token comment">//  String consumerTag, 消费者标签</span>
            <span class="token comment">// Envelope envelope, 信封 保存很多信息</span>
            <span class="token comment">// AMQP.BasicProperties properties, 属性</span>
            <span class="token comment">// byte[] body  消息字节数组</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token comment">//业务逻辑</span>

                <span class="token comment">//现在的业务逻辑就是打印</span>
<span class="token comment">//                System.out.println("consumerTag:"+consumerTag);</span>
<span class="token comment">//                System.out.println("Exchange:"+envelope.getExchange());</span>
<span class="token comment">//                System.out.println("RoutingKey:"+envelope.getRoutingKey());</span>
<span class="token comment">//                System.out.println("DeliveryTag:"+envelope.getDeliveryTag()); //消息id</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span>
<span class="token comment">//        channel.close();</span>
<span class="token comment">//        connection.close();</span>



    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><h5 id="c、消费者2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#c%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%852" aria-hidden="true">#</a> c、消费者2</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>publish</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer2</span> <span class="token punctuation">{</span>
    <span class="token comment">//交换机名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_EXCHAGE <span class="token operator">=</span> <span class="token string">"fanout_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_QUEUE_1 <span class="token operator">=</span> <span class="token string">"fanout_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_QUEUE_2 <span class="token operator">=</span> <span class="token string">"fanout_queue_2"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的ip</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的端口</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置虚拟主机</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置用户名</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置密码</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建长连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3创建channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明队列</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明交换机</span>
        <span class="token comment">// String exchange,  交换机名称</span>
        <span class="token comment">// BuiltinExchangeType type, 交换机类型</span>
        <span class="token comment">// boolean durable,  持久化</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>FANOUT_EXCHAGE<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>FANOUT<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//队列绑定交换机</span>
        <span class="token comment">// String queue, 队列名称</span>
        <span class="token comment">// String exchange, 交换机名称</span>
        <span class="token comment">// String routingKey 路由键</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">,</span>FANOUT_EXCHAGE<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">,</span>FANOUT_EXCHAGE<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//4监听某个队列</span>
        <span class="token comment">// String queue, 监听的队列名</span>
        <span class="token comment">// boolean autoAck, 是否自动应答</span>
        <span class="token comment">// Consumer callback 回调函数，收到消息，我要干啥</span>
        <span class="token class-name">Consumer</span> consumer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 回调函数，收到消息，我要干啥</span>
            <span class="token comment">//  String consumerTag, 消费者标签</span>
            <span class="token comment">// Envelope envelope, 信封 保存很多信息</span>
            <span class="token comment">// AMQP.BasicProperties properties, 属性</span>
            <span class="token comment">// byte[] body  消息字节数组</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token comment">//业务逻辑</span>

                <span class="token comment">//现在的业务逻辑就是打印</span>
<span class="token comment">//                System.out.println("consumerTag:"+consumerTag);</span>
<span class="token comment">//                System.out.println("Exchange:"+envelope.getExchange());</span>
<span class="token comment">//                System.out.println("RoutingKey:"+envelope.getRoutingKey());</span>
<span class="token comment">//                System.out.println("DeliveryTag:"+envelope.getDeliveryTag()); //消息id</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span>
<span class="token comment">//        channel.close();</span>
<span class="token comment">//        connection.close();</span>



    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><h4 id="_3-测试-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E6%B5%8B%E8%AF%95-1" aria-hidden="true">#</a> （3） 测试</h4><p>启动所有消费者，然后使用生产者发送消息；在每个消费者对应的控制台可以查看到生产者发送的所有消息；到达<strong>广播</strong>的效果。</p><p>在执行完测试代码后，其实到RabbitMQ的管理后台找到<code>Exchanges</code>选项卡，点击 <code>fanout_exchange</code> 的交换机，可以查看到如下的绑定：</p><p><img src="./RabbitMQ_files/image-20220411212807072.d93ba322.png" alt="image-20220411212807072" class="medium-zoom-image"></p><p>测试发送一条消息：</p><p>两个消费者都接受到同样的消息</p><p><img src="./RabbitMQ_files/image-20220411212727005.4caee19c.png" alt="image-20220411212727005" class="medium-zoom-image"></p><p><img src="./RabbitMQ_files/image-20220411212734150.3bcc1d8a.png" alt="image-20220411212734150" class="medium-zoom-image"></p><h4 id="_4-小结" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-%E5%B0%8F%E7%BB%93" aria-hidden="true">#</a> （4）小结</h4><p>交换机需要与队列进行绑定，绑定之后；一个消息可以被多个消费者都收到。</p><p><strong>发布订阅模式与工作队列模式的区别</strong></p><p>1、工作队列模式不用定义交换机，而发布/订阅模式需要定义交换机。</p><p>2、发布/订阅模式的生产方是面向交换机发送消息，工作队列模式的生产方是面向队列发送消息(底层使用默认交换机)。</p><p>3、发布/订阅模式需要设置队列和交换机的绑定，工作队列模式不需要设置，实际上工作队列模式会将队列绑 定到默认的交换机 。</p><h3 id="_4、routing路由模式-分布式日志收集系统" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81routing%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F" aria-hidden="true">#</a> 4、Routing路由模式（分布式日志收集系统）</h3><h4 id="_1-模式说明-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E-2" aria-hidden="true">#</a> （1）模式说明</h4><p>路由模式特点：</p><ul><li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个<code>RoutingKey</code>（路由key）</li><li>消息的发送方在 向 Exchange发送消息时，也必须指定消息的 <code>RoutingKey</code>。</li><li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的<code>Routing Key</code>进行判断，只有队列的<code>Routingkey</code>与消息的 <code>Routing key</code>完全一致，才会接收到消息</li></ul><p><img src="./RabbitMQ_files/1556029284397.8f3e1d3c.png" alt="1556029284397" class="medium-zoom-image"></p><p>图解：</p><ul><li>P：生产者，向Exchange发送消息，发送消息时，会指定一个routing key。</li><li>X：Exchange（交换机），接收生产者的消息，然后把消息递交给 与routing key完全匹配的队列</li><li>C1：消费者，其所在队列指定了需要routing key 为 error 的消息</li><li>C2：消费者，其所在队列指定了需要routing key 为 info、error、warning 的消息</li></ul><h4 id="_2-代码-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E4%BB%A3%E7%A0%81-2" aria-hidden="true">#</a> （2）代码</h4><p>在编码上与 <code>Publish/Subscribe发布与订阅模式</code> 的区别是交换机的类型为：Direct，还有队列绑定交换机的时候需要指定routing key。</p><h5 id="a、生产者-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#a%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85-1" aria-hidden="true">#</a> a、生产者</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>routing</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>

    <span class="token comment">//交换机名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DIRECT_EXCHAGE <span class="token operator">=</span> <span class="token string">"direct_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DIRECT_QUEUE_1 <span class="token operator">=</span> <span class="token string">"direct_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DIRECT_QUEUE_2 <span class="token operator">=</span> <span class="token string">"direct_queue_2"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的ip</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的端口</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置虚拟主机</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置用户名</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置密码</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建长连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3创建channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//声明队列</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>DIRECT_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明交换机</span>
        <span class="token comment">// String exchange,  交换机名称</span>
        <span class="token comment">// BuiltinExchangeType type, 交换机类型</span>
        <span class="token comment">// boolean durable,  持久化</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>DIRECT_EXCHAGE<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//队列绑定交换机</span>
        <span class="token comment">// String queue, 队列名称</span>
        <span class="token comment">// String exchange, 交换机名称</span>
        <span class="token comment">// String routingKey 路由键</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_1<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"warning"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4发消息</span>
        <span class="token comment">// String exchange,  交换机</span>
        <span class="token comment">// String routingKey, 路由键</span>
        <span class="token comment">// AMQP.BasicProperties props, 属性</span>
        <span class="token comment">// byte[] body 消息      string byte[] char[]如何相互转换的？</span>
        <span class="token class-name">String</span> msg<span class="token operator">=</span><span class="token string">"hello rabbitmq!routing error"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"error"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg1<span class="token operator">=</span><span class="token string">"hello rabbitmq!routing info"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"info"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>msg1<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg2<span class="token operator">=</span><span class="token string">"hello rabbitmq!routing warning"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"warning"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>msg2<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5关闭连接  资源关闭的顺序，先关后出来的资源，最后关，第一个资源</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><h5 id="b、消费者1-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#b%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%851-1" aria-hidden="true">#</a> b、消费者1</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>routing</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer1</span> <span class="token punctuation">{</span>
    <span class="token comment">//交换机名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DIRECT_EXCHAGE <span class="token operator">=</span> <span class="token string">"direct_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DIRECT_QUEUE_1 <span class="token operator">=</span> <span class="token string">"direct_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DIRECT_QUEUE_2 <span class="token operator">=</span> <span class="token string">"direct_queue_2"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的ip</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的端口</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置虚拟主机</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置用户名</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置密码</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建长连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3创建channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明队列</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>DIRECT_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明交换机</span>
        <span class="token comment">// String exchange,  交换机名称</span>
        <span class="token comment">// BuiltinExchangeType type, 交换机类型</span>
        <span class="token comment">// boolean durable,  持久化</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>DIRECT_EXCHAGE<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//队列绑定交换机</span>
        <span class="token comment">// String queue, 队列名称</span>
        <span class="token comment">// String exchange, 交换机名称</span>
        <span class="token comment">// String routingKey 路由键</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_1<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"warning"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//4监听某个队列</span>
        <span class="token comment">// String queue, 监听的队列名</span>
        <span class="token comment">// boolean autoAck, 是否自动应答</span>
        <span class="token comment">// Consumer callback 回调函数，收到消息，我要干啥</span>
        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span>Consumer</span> consumer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 回调函数，收到消息，我要干啥</span>
            <span class="token comment">//  String consumerTag, 消费者标签</span>
            <span class="token comment">// Envelope envelope, 信封 保存很多信息</span>
            <span class="token comment">// AMQP.BasicProperties properties, 属性</span>
            <span class="token comment">// byte[] body  消息字节数组</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token comment">//业务逻辑</span>

                <span class="token comment">//现在的业务逻辑就是打印</span>
<span class="token comment">//                System.out.println("consumerTag:"+consumerTag);</span>
<span class="token comment">//                System.out.println("Exchange:"+envelope.getExchange());</span>
<span class="token comment">//                System.out.println("RoutingKey:"+envelope.getRoutingKey());</span>
<span class="token comment">//                System.out.println("DeliveryTag:"+envelope.getDeliveryTag()); //消息id</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>DIRECT_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span>
<span class="token comment">//        channel.close();</span>
<span class="token comment">//        connection.close();</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br></div></div><h5 id="c、消费者2-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#c%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%852-1" aria-hidden="true">#</a> c、消费者2</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>routing</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer2</span> <span class="token punctuation">{</span>
    <span class="token comment">//交换机名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DIRECT_EXCHAGE <span class="token operator">=</span> <span class="token string">"direct_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DIRECT_QUEUE_1 <span class="token operator">=</span> <span class="token string">"direct_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DIRECT_QUEUE_2 <span class="token operator">=</span> <span class="token string">"direct_queue_2"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的ip</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的端口</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置虚拟主机</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置用户名</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置密码</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建长连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3创建channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明队列</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>DIRECT_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明交换机</span>
        <span class="token comment">// String exchange,  交换机名称</span>
        <span class="token comment">// BuiltinExchangeType type, 交换机类型</span>
        <span class="token comment">// boolean durable,  持久化</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>DIRECT_EXCHAGE<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//队列绑定交换机</span>
        <span class="token comment">// String queue, 队列名称</span>
        <span class="token comment">// String exchange, 交换机名称</span>
        <span class="token comment">// String routingKey 路由键</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_1<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span>DIRECT_EXCHAGE<span class="token punctuation">,</span><span class="token string">"warning"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//4监听某个队列</span>
        <span class="token comment">// String queue, 监听的队列名</span>
        <span class="token comment">// boolean autoAck, 是否自动应答</span>
        <span class="token comment">// Consumer callback 回调函数，收到消息，我要干啥</span>
        <span class="token class-name">Consumer</span> consumer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 回调函数，收到消息，我要干啥</span>
            <span class="token comment">//  String consumerTag, 消费者标签</span>
            <span class="token comment">// Envelope envelope, 信封 保存很多信息</span>
            <span class="token comment">// AMQP.BasicProperties properties, 属性</span>
            <span class="token comment">// byte[] body  消息字节数组</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token comment">//业务逻辑</span>

                <span class="token comment">//现在的业务逻辑就是打印</span>
<span class="token comment">//                System.out.println("consumerTag:"+consumerTag);</span>
<span class="token comment">//                System.out.println("Exchange:"+envelope.getExchange());</span>
<span class="token comment">//                System.out.println("RoutingKey:"+envelope.getRoutingKey());</span>
<span class="token comment">//                System.out.println("DeliveryTag:"+envelope.getDeliveryTag()); //消息id</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>DIRECT_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span>
<span class="token comment">//        channel.close();</span>
<span class="token comment">//        connection.close();</span>



    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><h4 id="_3-测试-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E6%B5%8B%E8%AF%95-2" aria-hidden="true">#</a> （3）测试</h4><p>启动所有消费者，然后使用生产者发送消息；在消费者对应的控制台可以查看到生产者发送对应routing key对应队列的消息；到达<strong>按照需要接收</strong>的效果。</p><p>在执行完测试代码后，其实到RabbitMQ的管理后台找到<code>Exchanges</code>选项卡，点击 <code>direct_exchange</code> 的交换机，可以查看到如下的绑定：</p><p><img src="./RabbitMQ_files/image-20220411214231000.1e1170ad.png" alt="image-20220411214231000" class="medium-zoom-image"></p><p>测试：</p><p>第一个消费者受到一条消息</p><p><img src="./RabbitMQ_files/image-20220411214259476.edf4f109.png" alt="image-20220411214259476" class="medium-zoom-image"></p><p>第二个消费者受到三条消息</p><p><img src="./RabbitMQ_files/image-20220411214316485.00473d19.png" alt="image-20220411214316485" class="medium-zoom-image"></p><h4 id="_4-小结-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-%E5%B0%8F%E7%BB%93-1" aria-hidden="true">#</a> （4）小结</h4><p>Routing模式要求队列在绑定交换机时要指定routing key，消息会转发到符合routing key的队列。</p><h3 id="_5、-topics通配符模式" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5%E3%80%81-topics%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F" aria-hidden="true">#</a> 5、 Topics通配符模式</h3><h4 id="_1-模式说明-3" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E-3" aria-hidden="true">#</a> （1） 模式说明</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ydlclass.taiyuan.caiwubu.info "本月工资大家涨两千！"
ydlclass.taiyuan.renshi.error "李老师携款潜逃！"
ydlclass.beijing.caiwubu.error "因为李老师逃了，全国所有校区降薪两千。不行就毕业！"
ydlclass.lasa.caiwubu.info "lasa校区成立了！"
ydlclass.taiyuan.shitangbu.info "太原校区学生吃饭免费！"
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>Topic</code>类型与<code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic</code>类型<code>Exchange</code>可以让队列在绑定<code>Routing key</code> 的时候<strong>使用通配符</strong>！</p><p><code>Routingkey</code> 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： <code>item.insert</code></p><p>通配符规则：</p><p><code>#</code>：匹配一个或多个词</p><p><code>*</code>：匹配不多不少恰好1个词</p><p>举例：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>我是太原校区校长 ydlclass.taiyuan.*.*
itlils 我是总部财务主管 ydlclass.*.caiwubu.*
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="./RabbitMQ_files/1556031362048.6cfc1105.png" alt="1556031362048" class="medium-zoom-image"></p><p><img src="./RabbitMQ_files/1556031519931.49fe6b22.png" alt="1556031519931" class="medium-zoom-image"></p><p>图解：</p><ul><li>红色Queue：绑定的是<code>usa.#</code> ，因此凡是以 <code>usa.</code>开头的<code>routing key</code> 都会被匹配到</li><li>黄色Queue：绑定的是<code>#.news</code> ，因此凡是以 <code>.news</code>结尾的 <code>routing key</code> 都会被匹配</li></ul><h4 id="_2-代码-3" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E4%BB%A3%E7%A0%81-3" aria-hidden="true">#</a> （2） 代码</h4><h5 id="a、生产者-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#a%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85-2" aria-hidden="true">#</a> a、生产者</h5><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>topic</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>

    <span class="token comment">//交换机名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_EXCHAGE <span class="token operator">=</span> <span class="token string">"topic_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_QUEUE_1 <span class="token operator">=</span> <span class="token string">"topic_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_QUEUE_2 <span class="token operator">=</span> <span class="token string">"topic_queue_2"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的ip</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的端口</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置虚拟主机</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置用户名</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置密码</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建长连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3创建channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//声明队列</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>TOPIC_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>TOPIC_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明交换机</span>
        <span class="token comment">// String exchange,  交换机名称</span>
        <span class="token comment">// BuiltinExchangeType type, 交换机类型</span>
        <span class="token comment">// boolean durable,  持久化</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>TOPIC_EXCHAGE<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//队列绑定交换机</span>
        <span class="token comment">// String queue, 队列名称</span>
        <span class="token comment">// String exchange, 交换机名称</span>
        <span class="token comment">// String routingKey 路由键</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>TOPIC_QUEUE_1<span class="token punctuation">,</span>TOPIC_EXCHAGE<span class="token punctuation">,</span><span class="token string">"ydlclass.taiyuan.*.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//我是太原校区校长的队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>TOPIC_QUEUE_2<span class="token punctuation">,</span>TOPIC_EXCHAGE<span class="token punctuation">,</span><span class="token string">"ydlclass.*.caiwubu.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我是总部财务主管的队列</span>

        <span class="token comment">//4发消息</span>
        <span class="token comment">// String exchange,  交换机</span>
        <span class="token comment">// String routingKey, 路由键</span>
        <span class="token comment">// AMQP.BasicProperties props, 属性</span>
        <span class="token comment">// byte[] body 消息      string byte[] char[]如何相互转换的？</span>
        <span class="token class-name">String</span> msg1<span class="token operator">=</span><span class="token string">"hello rabbitmq!topic  本月工资大家涨两千！"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>TOPIC_EXCHAGE<span class="token punctuation">,</span><span class="token string">"ydlclass.taiyuan.caiwubu.info"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>msg1<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg2<span class="token operator">=</span><span class="token string">"hello rabbitmq!topic 李老师携款潜逃！"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>TOPIC_EXCHAGE<span class="token punctuation">,</span><span class="token string">"ydlclass.taiyuan.renshi.error"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>msg2<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg3<span class="token operator">=</span><span class="token string">"hello rabbitmq!topic  因为李老师逃了，全国所有校区降薪两千。不行就毕业！"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>TOPIC_EXCHAGE<span class="token punctuation">,</span><span class="token string">"ydlclass.beijing.caiwubu.error"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>msg3<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5关闭连接  资源关闭的顺序，先关后出来的资源，最后关，第一个资源</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h5 id="b、消费者1-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#b%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%851-2" aria-hidden="true">#</a> b、消费者1</h5><p>接收两种类型的消息：更新商品和删除商品</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>topic</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer1</span> <span class="token punctuation">{</span>
    <span class="token comment">//交换机名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_EXCHAGE <span class="token operator">=</span> <span class="token string">"topic_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_QUEUE_1 <span class="token operator">=</span> <span class="token string">"topic_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_QUEUE_2 <span class="token operator">=</span> <span class="token string">"topic_queue_2"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的ip</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的端口</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置虚拟主机</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置用户名</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置密码</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建长连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3创建channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明队列</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>TOPIC_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>TOPIC_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明交换机</span>
        <span class="token comment">// String exchange,  交换机名称</span>
        <span class="token comment">// BuiltinExchangeType type, 交换机类型</span>
        <span class="token comment">// boolean durable,  持久化</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>TOPIC_EXCHAGE<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//队列绑定交换机</span>
        <span class="token comment">// String queue, 队列名称</span>
        <span class="token comment">// String exchange, 交换机名称</span>
        <span class="token comment">// String routingKey 路由键</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>TOPIC_QUEUE_1<span class="token punctuation">,</span>TOPIC_EXCHAGE<span class="token punctuation">,</span><span class="token string">"ydlclass.taiyuan.*.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//我是太原校区校长的队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>TOPIC_QUEUE_2<span class="token punctuation">,</span>TOPIC_EXCHAGE<span class="token punctuation">,</span><span class="token string">"ydlclass.*.caiwubu.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我是总部财务主管的队列</span>


        <span class="token comment">//4监听某个队列</span>
        <span class="token comment">// String queue, 监听的队列名</span>
        <span class="token comment">// boolean autoAck, 是否自动应答</span>
        <span class="token comment">// Consumer callback 回调函数，收到消息，我要干啥</span>
        <span class="token class-name">Consumer</span> consumer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 回调函数，收到消息，我要干啥</span>
            <span class="token comment">//  String consumerTag, 消费者标签</span>
            <span class="token comment">// Envelope envelope, 信封 保存很多信息</span>
            <span class="token comment">// AMQP.BasicProperties properties, 属性</span>
            <span class="token comment">// byte[] body  消息字节数组</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token comment">//业务逻辑</span>

                <span class="token comment">//现在的业务逻辑就是打印</span>
<span class="token comment">//                System.out.println("consumerTag:"+consumerTag);</span>
<span class="token comment">//                System.out.println("Exchange:"+envelope.getExchange());</span>
<span class="token comment">//                System.out.println("RoutingKey:"+envelope.getRoutingKey());</span>
<span class="token comment">//                System.out.println("DeliveryTag:"+envelope.getDeliveryTag()); //消息id</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>TOPIC_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span>
<span class="token comment">//        channel.close();</span>
<span class="token comment">//        connection.close();</span>



    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><h5 id="c、消费者2-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#c%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%852-2" aria-hidden="true">#</a> c、消费者2</h5><p>接收所有类型的消息：新增商品，更新商品和删除商品。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>topic</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer2</span> <span class="token punctuation">{</span>
    <span class="token comment">//交换机名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_EXCHAGE <span class="token operator">=</span> <span class="token string">"topic_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_QUEUE_1 <span class="token operator">=</span> <span class="token string">"topic_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_QUEUE_2 <span class="token operator">=</span> <span class="token string">"topic_queue_2"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的ip</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接的端口</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置虚拟主机</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置用户名</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置密码</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"itlils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2创建长连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3创建channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明队列</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>TOPIC_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>TOPIC_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明交换机</span>
        <span class="token comment">// String exchange,  交换机名称</span>
        <span class="token comment">// BuiltinExchangeType type, 交换机类型</span>
        <span class="token comment">// boolean durable,  持久化</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>TOPIC_EXCHAGE<span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//队列绑定交换机</span>
        <span class="token comment">// String queue, 队列名称</span>
        <span class="token comment">// String exchange, 交换机名称</span>
        <span class="token comment">// String routingKey 路由键</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>TOPIC_QUEUE_1<span class="token punctuation">,</span>TOPIC_EXCHAGE<span class="token punctuation">,</span><span class="token string">"ydlclass.taiyuan.*.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//我是太原校区校长的队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>TOPIC_QUEUE_2<span class="token punctuation">,</span>TOPIC_EXCHAGE<span class="token punctuation">,</span><span class="token string">"ydlclass.*.caiwubu.*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我是总部财务主管的队列</span>


        <span class="token comment">//4监听某个队列</span>
        <span class="token comment">// String queue, 监听的队列名</span>
        <span class="token comment">// boolean autoAck, 是否自动应答</span>
        <span class="token comment">// Consumer callback 回调函数，收到消息，我要干啥</span>
        <span class="token class-name">Consumer</span> consumer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 回调函数，收到消息，我要干啥</span>
            <span class="token comment">//  String consumerTag, 消费者标签</span>
            <span class="token comment">// Envelope envelope, 信封 保存很多信息</span>
            <span class="token comment">// AMQP.BasicProperties properties, 属性</span>
            <span class="token comment">// byte[] body  消息字节数组</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token comment">//业务逻辑</span>

                <span class="token comment">//现在的业务逻辑就是打印</span>
<span class="token comment">//                System.out.println("consumerTag:"+consumerTag);</span>
<span class="token comment">//                System.out.println("Exchange:"+envelope.getExchange());</span>
<span class="token comment">//                System.out.println("RoutingKey:"+envelope.getRoutingKey());</span>
<span class="token comment">//                System.out.println("DeliveryTag:"+envelope.getDeliveryTag()); //消息id</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>TOPIC_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span>
<span class="token comment">//        channel.close();</span>
<span class="token comment">//        connection.close();</span>



    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><h4 id="_3-测试-3" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E6%B5%8B%E8%AF%95-3" aria-hidden="true">#</a> （3）测试</h4><p>启动所有消费者，然后使用生产者发送消息；在消费者对应的控制台可以查看到生产者发送对应routing key对应队列的消息；到达<strong>按照需要接收</strong>的效果；并且这些routing key可以使用通配符。</p><p>在执行完测试代码后，其实到RabbitMQ的管理后台找到<code>Exchanges</code>选项卡，点击 <code>topic_exchange</code> 的交换机，可以查看到如下的绑定：</p><p><img src="./RabbitMQ_files/image-20220411220413658.af621fe7.png" alt="image-20220411220413658" class="medium-zoom-image"></p><p>测试：</p><p>消费者1 接受2条消息</p><p><img src="./RabbitMQ_files/image-20220411220433328.8c0bb510.png" alt="image-20220411220433328" class="medium-zoom-image"></p><p>消费者2 接受2条消息</p><p><img src="./RabbitMQ_files/image-20220411220453524.41faca02.png" alt="image-20220411220453524" class="medium-zoom-image"></p><h4 id="_4-小结-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-%E5%B0%8F%E7%BB%93-2" aria-hidden="true">#</a> （4）小结</h4><p>Topic主题模式可以实现 <code>Publish/Subscribe发布与订阅模式</code> 和 <code> Routing路由模式</code> 的功能；只是Topic在配置routing key 的时候可以使用通配符，显得更加灵活。</p><h3 id="_6、-模式总结" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_6%E3%80%81-%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93" aria-hidden="true">#</a> 6、 模式总结</h3><p>RabbitMQ工作模式：</p><h4 id="_1-简单模式-helloworld" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F-helloworld" aria-hidden="true">#</a> <strong>（1）简单模式 HelloWorld</strong></h4><p>一个生产者、一个消费者，不需要设置交换机（使用默认的交换机）。</p><h4 id="_2-工作队列模式-work-queue" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F-work-queue" aria-hidden="true">#</a> <strong>（2）工作队列模式 Work Queue</strong></h4><p>一个生产者、多个消费者（竞争关系），不需要设置交换机（使用默认的交换机）。</p><h4 id="_3-发布订阅模式-publish-subscribe" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-publish-subscribe" aria-hidden="true">#</a> <strong>（3）发布订阅模式 Publish/subscribe</strong></h4><p>需要设置类型为fanout的交换机，并且交换机和队列进行绑定，当发送消息到交换机后，交换机会将消息发送到绑定的队列。</p><h4 id="_4-路由模式-routing" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F-routing" aria-hidden="true">#</a> <strong>（4）路由模式 Routing</strong></h4><p>需要设置类型为direct的交换机，交换机和队列进行绑定，并且指定routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列。</p><h4 id="_5-通配符模式-topic" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5-%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F-topic" aria-hidden="true">#</a> <strong>（5）通配符模式 Topic</strong></h4><p>需要设置类型为topic的交换机，交换机和队列进行绑定，并且指定通配符方式的routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列。</p><h2 id="第六章-spring-整合rabbitmq-了解" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E5%85%AD%E7%AB%A0-spring-%E6%95%B4%E5%90%88rabbitmq-%E4%BA%86%E8%A7%A3" aria-hidden="true">#</a> 第六章 Spring 整合RabbitMQ-了解</h2><h3 id="_1、搭建生产者工程" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E7%A8%8B" aria-hidden="true">#</a> 1、搭建生产者工程</h3><h4 id="_1-创建工程-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B-1" aria-hidden="true">#</a> （1）创建工程</h4><p>spring-rabbitmq-producer</p><p><img src="./RabbitMQ_files/image-20200320222056543.22a9b177.png" alt="image-20200320222056543" class="medium-zoom-image"></p><h4 id="_2-添加依赖-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-1" aria-hidden="true">#</a> （2）添加依赖</h4><p>修改pom.xml文件内容为如下：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydlclass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbitmq-producer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h4 id="_3-配置整合" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E9%85%8D%E7%BD%AE%E6%95%B4%E5%90%88" aria-hidden="true">#</a> （3） 配置整合</h4><ol><li>创建<code>resources\rabbitmq.properties</code>连接参数等配置文件；</li></ol><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">rabbitmq.host</span><span class="token punctuation">=</span><span class="token attr-value">localhost</span>
<span class="token attr-name">rabbitmq.port</span><span class="token punctuation">=</span><span class="token attr-value">5672</span>
<span class="token attr-name">rabbitmq.username</span><span class="token punctuation">=</span><span class="token attr-value">itlils</span>
<span class="token attr-name">rabbitmq.password</span><span class="token punctuation">=</span><span class="token attr-value">itlils</span>
<span class="token attr-name">rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token attr-value">/</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>创建 <code>resources\spring-rabbitmq.xml</code> 整合配置文件；</li></ol><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>rabbit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/rabbit<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       https://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/rabbit
       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--加载配置文件--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:rabbitmq.properties<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>connection-factory</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span>
                               <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.host}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.port}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.username}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.password}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">virtual-host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.virtual-host}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--定义管理交换机、队列--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>admin</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--定义持久化队列，不存在则自动创建；不绑定到交换机则绑定到默认交换机
    默认交换机类型为direct，名字为：""，路由键为队列的名称
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ydlqueue<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ydlqueue<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~广播；所有队列都能收到消息~~~~~~~~~~~~~~~~~~~~~~~~~~~~ --&gt;</span>
    <span class="token comment">&lt;!--定义广播交换机中的持久化队列，不存在则自动创建--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_fanout_queue_1<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_fanout_queue_1<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">auto-delete</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">durable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--定义广播交换机中的持久化队列，不存在则自动创建--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_fanout_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_fanout_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--定义广播类型交换机；并绑定上述两个队列--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>fanout-exchange</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_fanout_exchange<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_fanout_exchange<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_fanout_queue_1<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_fanout_queue_2<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>fanout-exchange</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- routing 模式--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_queue_1<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_queue_1<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>direct-exchange</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_exchange<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_exchange<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_queue_1<span class="token punctuation">"</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>info<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_direct_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>warning<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>direct-exchange</span><span class="token punctuation">&gt;</span></span>


    <span class="token comment">&lt;!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~通配符；*匹配一个单词，#匹配多个单词 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_topic_queue_1<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_topic_queue_1<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_topic_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_topic_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_topic_exchange<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_topic_exchange<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_topic_queue_1<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ydlclass.taiyuan.*.*<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring_topic_queue_2<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ydlclass.*.caiwubu.*<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rabbitTemplate<span class="token punctuation">"</span></span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p><strong>注意</strong>：</p><p>xxxtemplate作用就是帮我们和第三方组件键连接，断链接。我们只需要关注核心业务逻辑即可。</p><h4 id="_4-发送消息" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF" aria-hidden="true">#</a> （4）发送消息</h4><p><img src="./RabbitMQ_files/image-20220413210312813.86100d12.png" alt="image-20220413210312813" class="medium-zoom-image"></p><p>创建测试文件 test\java\com\ydlclass\rabbitmq\ProducerTest.java</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ContextConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span>locations <span class="token operator">=</span> <span class="token string">"classpath:spring-rabbitmq.xml"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token comment">//简单模式发送</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">helloTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// String exchange,  交换机</span>
        <span class="token comment">// String routingKey,  路由键</span>
        <span class="token comment">// Object message     Object消息体 User car lunchuan</span>
        <span class="token class-name">String</span> msg<span class="token operator">=</span><span class="token string">"hello rabbitmq!"</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"ydlqueue"</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//测试发布订阅模式</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg<span class="token operator">=</span><span class="token string">"hello rabbitmq! publish"</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"spring_fanout_exchange"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//测试routing模式</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">routingTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg<span class="token operator">=</span><span class="token string">"hello rabbitmq!routing error"</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"spring_direct_exchange"</span><span class="token punctuation">,</span><span class="token string">"error"</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg1<span class="token operator">=</span><span class="token string">"hello rabbitmq!routing info"</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"spring_direct_exchange"</span><span class="token punctuation">,</span><span class="token string">"info"</span><span class="token punctuation">,</span>msg1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg2<span class="token operator">=</span><span class="token string">"hello rabbitmq!routing warning"</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"spring_direct_exchange"</span><span class="token punctuation">,</span><span class="token string">"warning"</span><span class="token punctuation">,</span>msg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//测试topic模式</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">topicTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg1<span class="token operator">=</span><span class="token string">"hello rabbitmq!topic  本月工资大家涨两千！"</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"spring_topic_exchange"</span><span class="token punctuation">,</span><span class="token string">"ydlclass.taiyuan.caiwubu.info"</span><span class="token punctuation">,</span>msg1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg2<span class="token operator">=</span><span class="token string">"hello rabbitmq!topic 李老师携款潜逃！"</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"spring_topic_exchange"</span><span class="token punctuation">,</span><span class="token string">"ydlclass.taiyuan.renshi.error"</span><span class="token punctuation">,</span>msg2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg3<span class="token operator">=</span><span class="token string">"hello rabbitmq!topic  因为李老师逃了，全国所有校区降薪两千。不行就毕业！"</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"spring_topic_exchange"</span><span class="token punctuation">,</span><span class="token string">"ydlclass.beijing.caiwubu.error"</span><span class="token punctuation">,</span>msg3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>发布订阅：</p><p>发送者</p><p><img src="./RabbitMQ_files/image-20220413211130569.cbb13308.png" alt="image-20220413211130569" class="medium-zoom-image"></p><p>队列：两个队列都有一条消息</p><p><img src="./RabbitMQ_files/image-20220413211231511.7448120c.png" alt="image-20220413211231511" class="medium-zoom-image"></p><p>路由模式：</p><p><img src="./RabbitMQ_files/image-20220413212246642.12850ddb.png" alt="image-20220413212246642" class="medium-zoom-image"></p><p>队列1只有1条消息</p><p><img src="./RabbitMQ_files/image-20220413212324693.ee3bfce9.png" alt="image-20220413212324693" class="medium-zoom-image"></p><p>队列2有3条消息</p><p><img src="./RabbitMQ_files/image-20220413212349991.7afe9e22.png" alt="image-20220413212349991" class="medium-zoom-image"></p><p>topic模式：</p><p><img src="./RabbitMQ_files/image-20220413213316120.9a5638cf.png" alt="image-20220413213316120" class="medium-zoom-image"></p><p>队列1 2条消息</p><p><img src="./RabbitMQ_files/image-20220413213334943.f6c4e0da.png" alt="image-20220413213334943" class="medium-zoom-image"></p><p>队列2 2条消息</p><p><img src="./RabbitMQ_files/image-20220413213345957.8a6ac58c.png" alt="image-20220413213345957" class="medium-zoom-image"></p><h3 id="_2、搭建消费者工程" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81%E6%90%AD%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E5%B7%A5%E7%A8%8B" aria-hidden="true">#</a> 2、搭建消费者工程</h3><h4 id="_1-创建工程-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B-2" aria-hidden="true">#</a> （1）创建工程</h4><p>spring-rabbitmq-consumer</p><p><img src="./RabbitMQ_files/image-20220413215506816.413652ef.png" alt="image-20220413215506816" class="medium-zoom-image"></p><h4 id="_2-添加依赖-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-2" aria-hidden="true">#</a> （2）添加依赖</h4><p>修改pom.xml文件内容为如下：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydlclass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbitmq-consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="_3-配置整合-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E9%85%8D%E7%BD%AE%E6%95%B4%E5%90%88-1" aria-hidden="true">#</a> （3） 配置整合</h4><ol><li>创建<code>resources\rabbitmq.properties</code>连接参数等配置文件；</li></ol><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">rabbitmq.host</span><span class="token punctuation">=</span><span class="token attr-value">localhost</span>
<span class="token attr-name">rabbitmq.port</span><span class="token punctuation">=</span><span class="token attr-value">5672</span>
<span class="token attr-name">rabbitmq.username</span><span class="token punctuation">=</span><span class="token attr-value">itlils</span>
<span class="token attr-name">rabbitmq.password</span><span class="token punctuation">=</span><span class="token attr-value">itlils</span>
<span class="token attr-name">rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token attr-value">/</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>创建 resources\spring-rabbitmq.xml` 整合配置文件；</li></ol><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>rabbit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/rabbit<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       https://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/rabbit
       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--加载配置文件--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:rabbitmq.properties<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>connection-factory</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span>
                               <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.host}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.port}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.username}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.password}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">virtual-host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.virtual-host}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>springQueueListener<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.ydlclass.rabbitmq.listener.SpringQueueListener<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token comment">&lt;!--    &lt;bean id="fanoutListener1" class="com.ydlclass.rabbitmq.listener.FanoutListener1"/&gt;--&gt;</span>
<span class="token comment">&lt;!--    &lt;bean id="fanoutListener2" class="com.ydlclass.rabbitmq.listener.FanoutListener2"/&gt;--&gt;</span>
<span class="token comment">&lt;!--    &lt;bean id="topicListenerStar" class="com.ydlclass.rabbitmq.listener.TopicListenerStar"/&gt;--&gt;</span>
<span class="token comment">&lt;!--    &lt;bean id="topicListenerWell" class="com.ydlclass.rabbitmq.listener.TopicListenerWell"/&gt;--&gt;</span>
<span class="token comment">&lt;!--    &lt;bean id="topicListenerWell2" class="com.ydlclass.rabbitmq.listener.TopicListenerWell2"/&gt;--&gt;</span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener-container</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">auto-declare</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>springQueueListener<span class="token punctuation">"</span></span> <span class="token attr-name">queue-names</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ydlqueue<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token comment">&lt;!--        &lt;rabbit:listener ref="fanoutListener1" queue-names="spring_fanout_queue_1"/&gt;--&gt;</span>
<span class="token comment">&lt;!--        &lt;rabbit:listener ref="fanoutListener2" queue-names="spring_fanout_queue_2"/&gt;--&gt;</span>
<span class="token comment">&lt;!--        &lt;rabbit:listener ref="topicListenerStar" queue-names="spring_topic_queue_star"/&gt;--&gt;</span>
<span class="token comment">&lt;!--        &lt;rabbit:listener ref="topicListenerWell" queue-names="spring_topic_queue_well"/&gt;--&gt;</span>
<span class="token comment">&lt;!--        &lt;rabbit:listener ref="topicListenerWell2" queue-names="spring_topic_queue_well2"/&gt;--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>listener-container</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="_4-消息监听器" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-%E6%B6%88%E6%81%AF%E7%9B%91%E5%90%AC%E5%99%A8" aria-hidden="true">#</a> （4） 消息监听器</h4><h5 id="a、队列监听器" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#a%E3%80%81%E9%98%9F%E5%88%97%E7%9B%91%E5%90%AC%E5%99%A8" aria-hidden="true">#</a> a、队列监听器</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\SpringQueueListener.java</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">MessageListener</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token comment">//缺啥补啥 干就完事</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringQueueListener</span> <span class="token keyword">implements</span> <span class="token class-name">MessageListener</span> <span class="token punctuation">{</span>
    <span class="token comment">//有了消息 做什么</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//业务逻辑</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>为了让spring容器一直运行，我们需要在测试类中，启动spring容器：com.ydlclass.rabbimq</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ContextConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span>locations <span class="token operator">=</span> <span class="token string">"classpath:spring-rabbitmq.xml"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumerTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h5 id="b、广播监听器1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#b%E3%80%81%E5%B9%BF%E6%92%AD%E7%9B%91%E5%90%AC%E5%99%A81" aria-hidden="true">#</a> b、广播监听器1</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\FanoutListener1.java</code></p><h5 id="c、广播监听器2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#c%E3%80%81%E5%B9%BF%E6%92%AD%E7%9B%91%E5%90%AC%E5%99%A82" aria-hidden="true">#</a> c、广播监听器2</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\FanoutListener2.java</code></p><h5 id="d、星号通配符监听器" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#d%E3%80%81%E6%98%9F%E5%8F%B7%E9%80%9A%E9%85%8D%E7%AC%A6%E7%9B%91%E5%90%AC%E5%99%A8" aria-hidden="true">#</a> d、星号通配符监听器</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\TopicListenerStar.java</code></p><h5 id="e、井号通配符监听器" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#e%E3%80%81%E4%BA%95%E5%8F%B7%E9%80%9A%E9%85%8D%E7%AC%A6%E7%9B%91%E5%90%AC%E5%99%A8" aria-hidden="true">#</a> e、井号通配符监听器</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\TopicListenerWell.java</code></p><h5 id="f、井号通配符监听器2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#f%E3%80%81%E4%BA%95%E5%8F%B7%E9%80%9A%E9%85%8D%E7%AC%A6%E7%9B%91%E5%90%AC%E5%99%A82" aria-hidden="true">#</a> f、井号通配符监听器2</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\TopicListenerWell2.java</code></p><p>测试：</p><p><img src="./RabbitMQ_files/image-20220413215534196.0ac570bd.png" alt="image-20220413215534196" class="medium-zoom-image"></p><h2 id="第七章-spring-boot整合rabbitmq" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%B8%83%E7%AB%A0-spring-boot%E6%95%B4%E5%90%88rabbitmq" aria-hidden="true">#</a> 第七章 Spring Boot整合RabbitMQ</h2><h3 id="_1、-简介" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81-%E7%AE%80%E4%BB%8B" aria-hidden="true">#</a> 1、 简介</h3><p>在Spring项目中，可以使用Spring-Rabbit去操作RabbitMQ https://github.com/spring-projects/spring-amqp</p><p>尤其是在spring boot项目中只需要引入对应的amqp启动器依赖即可，方便的使用RabbitTemplate发送消息，使用注解接收消息。</p><p><em>一般在开发过程中</em>：</p><p><strong>生产者工程：</strong></p><ol><li><p>application.yml文件配置RabbitMQ相关信息；</p></li><li><p>在生产者工程中编写配置类，用于创建交换机和队列，并进行绑定</p></li><li><p>注入RabbitTemplate对象，通过RabbitTemplate对象发送消息到交换机</p></li></ol><p><strong>消费者工程：</strong></p><ol><li><p>application.yml文件配置RabbitMQ相关信息</p></li><li><p>创建消息处理类，用于接收队列中的消息并进行处理</p></li></ol><h3 id="_2、搭建生产者工程" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E7%A8%8B" aria-hidden="true">#</a> 2、搭建生产者工程</h3><h4 id="_1-创建工程-3" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B-3" aria-hidden="true">#</a> （1） 创建工程</h4><p>创建生产者工程springboot-rabbitmq-producer</p><p><img src="./RabbitMQ_files/image-20220413222931239.b56a680b.png" alt="image-20220413222931239" class="medium-zoom-image"></p><h4 id="_2-添加依赖-3" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-3" aria-hidden="true">#</a> （2） 添加依赖</h4><p>修改pom.xml文件内容为如下：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydlclass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springboot-rabbitmq-producer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="_3-启动类" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E5%90%AF%E5%8A%A8%E7%B1%BB" aria-hidden="true">#</a> （3） 启动类</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerApp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ProducerApp</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_4-配置rabbitmq" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-%E9%85%8D%E7%BD%AErabbitmq" aria-hidden="true">#</a> （4）配置RabbitMQ</h4><h5 id="a、配置文件" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#a%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" aria-hidden="true">#</a> a、配置文件</h5><p>创建application.yml，内容如下：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /
    <span class="token key atrule">username</span><span class="token punctuation">:</span> itlils
    <span class="token key atrule">password</span><span class="token punctuation">:</span> itlils
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="b、绑定交换机和队列" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#b%E3%80%81%E7%BB%91%E5%AE%9A%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%92%8C%E9%98%9F%E5%88%97" aria-hidden="true">#</a> b、绑定交换机和队列</h5><p>创建RabbitMQ队列与交换机绑定的配置类com.ydlclass.rabbitmq.config.RabbitMQConfig</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Qualifier</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"boot_hello_queue"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//String queue,  队列名</span>
        <span class="token comment">// boolean durable, 持久化</span>
        <span class="token comment">// boolean exclusive, 排他的</span>
        <span class="token comment">// boolean autoDelete, 自动删除</span>
        <span class="token comment">// Map&lt;String, Object&gt; arguments 属性</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"boot_hello_queue"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//发布订阅模式</span>
    <span class="token comment">//交换机名称</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_EXCHAGE <span class="token operator">=</span> <span class="token string">"boot_fanout_exchange"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_QUEUE_1 <span class="token operator">=</span> <span class="token string">"boot_fanout_queue_1"</span><span class="token punctuation">;</span>
    <span class="token comment">//队列名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FANOUT_QUEUE_2 <span class="token operator">=</span> <span class="token string">"boot_fanout_queue_2"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">FANOUT_QUEUE_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">FANOUT_QUEUE_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>FANOUT_EXCHAGE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">FANOUT_EXCHAGE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">fanoutExchange</span><span class="token punctuation">(</span>FANOUT_EXCHAGE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">FANOUT_QUEUE_1_FANOUT_EXCHAGE</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span>FANOUT_QUEUE_1<span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span>
                                                 <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span>FANOUT_EXCHAGE<span class="token punctuation">)</span> <span class="token class-name">Exchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">FANOUT_QUEUE_2_FANOUT_EXCHAGE</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span>FANOUT_QUEUE_2<span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span>
                                                 <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span>FANOUT_EXCHAGE<span class="token punctuation">)</span> <span class="token class-name">Exchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//作业</span>
    <span class="token comment">//routing模式</span>

    <span class="token comment">//topic模式</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>测试类</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>package com.ydlclass.rabbitmq;

import com.ydlclass.rabbitmq.config.RabbitConfig;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */
@RunWith(SpringRunner.class)
@SpringBootTest(classes = ProducerApp.class)
public class ProducerTest {

    @Autowired
    RabbitTemplate rabbitTemplate;

    @Test
    public void helloTest(){
        String msg="hello rabbitmq!";
        rabbitTemplate.convertAndSend("","boot_hello_queue",msg);
    }

    @Test
    public void publishTest(){
        String msg="hello rabbitmq!publishTest";
        rabbitTemplate.convertAndSend(RabbitConfig.FANOUT_EXCHAGE,"",msg);
    }

    //作业 routing
    //topic
}

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>简单模式：</p><p><img src="./RabbitMQ_files/image-20220413221046286.35eb38b7.png" alt="image-20220413221046286" class="medium-zoom-image"></p><p>发布订阅：</p><p><img src="./RabbitMQ_files/image-20220413222539201.769338b4.png" alt="image-20220413222539201" class="medium-zoom-image"></p><p>每个队列都有一条消息了</p><p><img src="./RabbitMQ_files/image-20220413222558184.c6db4b62.png" alt="image-20220413222558184" class="medium-zoom-image"></p><p>​ <img src="./RabbitMQ_files/image-20220413222609681.d010ab71.png" alt="image-20220413222609681" class="medium-zoom-image"></p><h3 id="_3、搭建消费者工程" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E6%90%AD%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E5%B7%A5%E7%A8%8B" aria-hidden="true">#</a> 3、搭建消费者工程</h3><h4 id="_1-创建工程-4" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B-4" aria-hidden="true">#</a> （1） 创建工程</h4><p>创建消费者工程springboot-rabbitmq-consumer</p><p><img src="./RabbitMQ_files/image-20220413233208158.458a7865.png" alt="image-20220413233208158" class="medium-zoom-image"></p><h4 id="_2-添加依赖-4" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-4" aria-hidden="true">#</a> （2） 添加依赖</h4><p>修改pom.xml文件内容为如下：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydlclass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springboot-rabbitmq-consumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_3-启动类-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E5%90%AF%E5%8A%A8%E7%B1%BB-1" aria-hidden="true">#</a> （3） 启动类</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerApp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConsumerApp</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="_4-配置rabbitmq-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-%E9%85%8D%E7%BD%AErabbitmq-1" aria-hidden="true">#</a> （4） 配置RabbitMQ</h4><p>创建application.yml，内容如下：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /
    <span class="token key atrule">username</span><span class="token punctuation">:</span> itlils
    <span class="token key atrule">password</span><span class="token punctuation">:</span> itlils
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_5-消息监听处理类" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5-%E6%B6%88%E6%81%AF%E7%9B%91%E5%90%AC%E5%A4%84%E7%90%86%E7%B1%BB" aria-hidden="true">#</a> （5） 消息监听处理类</h4><p>编写消息监听器com.ydlclass.rabbitmq.listener.MyListener</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RabbitConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">MessageProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Created by IT李老师
 * 公主号 “元动力课堂”
 * 个人微 itlils
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitConfig</span><span class="token punctuation">.</span>FANOUT_QUEUE_1<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMsg</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//业务逻辑</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//参数</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messageProperties<span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messageProperties<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messageProperties<span class="token punctuation">.</span><span class="token function">getReceivedRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messageProperties<span class="token punctuation">.</span><span class="token function">getConsumerTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_4、-测试" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81-%E6%B5%8B%E8%AF%95" aria-hidden="true">#</a> 4、 测试</h3><p>先运行上述测试程序（交换机和队列才能先被声明和绑定），然后启动消费者；在消费者工程springboot-rabbitmq-consumer中控制台查看是否接收到对应消息。</p><p>另外；也可以在RabbitMQ的管理控制台中查看到交换机与队列的绑定。</p><h1 id="rabbitmq高级-学习目标" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#rabbitmq%E9%AB%98%E7%BA%A7-%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87" aria-hidden="true">#</a> RabbitMQ高级 学习目标</h1><ul><li><p>掌握RabbitMQ 高级特性</p></li><li><p>理解RabbitMQ 应用问题</p></li><li><p>能够搭建RabbitMQ 集群</p><p><img src="./RabbitMQ_files/image-20200320230112442.9919b2e6.png" alt="image-20200320230112442" class="medium-zoom-image"></p></li></ul><h2 id="第一章-rabbitmq-高级特性" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%B8%80%E7%AB%A0-rabbitmq-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" aria-hidden="true">#</a> 第一章 RabbitMQ 高级特性</h2><p><img src="./RabbitMQ_files/image-20200616093631383.0e0db4ef.png" alt="image-20200616093631383" class="medium-zoom-image"></p><h3 id="_1、消息可靠性投递" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92" aria-hidden="true">#</a> 1、消息可靠性投递</h3><p>在使用 RabbitMQ 的时候，作为消息发送方希望杜绝任何消息丢失或者投递失败场景。RabbitMQ 为我们提供了两种方式用来控制消息的投递可靠性模式。</p><ul><li><p>confirm <strong>确认模式</strong></p></li><li><p>return <strong>退回模式</strong></p></li></ul><p>rabbitmq 整个消息投递的路径为：</p><p>​ <strong>producer ---&gt; rabbitmq broker ---&gt; exchange ---&gt; queue ---&gt; consumer</strong></p><ul><li><p>消息从 producer 到 exchange 则会返回一个 confirmCallback 。</p></li><li><p>消息从 exchange 到 queue 投递失败则会返回一个 returnCallback 。</p></li></ul><p>我们将利用这两个 callback 控制消息的可靠性投递</p><h4 id="_1-confirm确认模式代码实现" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-confirm%E7%A1%AE%E8%AE%A4%E6%A8%A1%E5%BC%8F%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" aria-hidden="true">#</a> （1）confirm确认模式代码实现</h4><ol><li><p>创建maven工程，消息的生产者工程，项目模块名称：rabbitmq-producer-spring</p></li><li><p>添加依赖</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div></li><li><p>在 resources 目录下创建 rabbitmq.properties 配置文件，添加连接RabbitMQ相关信息</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">rabbitmq.host</span><span class="token punctuation">=</span><span class="token attr-value">localhost</span>
<span class="token attr-name">rabbitmq.port</span><span class="token punctuation">=</span><span class="token attr-value">5672</span>
<span class="token attr-name">rabbitmq.username</span><span class="token punctuation">=</span><span class="token attr-value">guest</span>
<span class="token attr-name">rabbitmq.password</span><span class="token punctuation">=</span><span class="token attr-value">guest</span>
<span class="token attr-name">rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token attr-value">/</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p>在 resources 目录下创建 spring-rabbitmq-producer.xml 配置文件，添加以下配置</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>rabbit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/rabbit<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans
                 http://www.springframework.org/schema/beans/spring-beans.xsd
                 http://www.springframework.org/schema/context
                 https://www.springframework.org/schema/context/spring-context.xsd
                 http://www.springframework.org/schema/rabbit
                 http://www.springframework.org/schema/rabbit/spring-rabbit.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--加载配置文件--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:rabbitmq.properties<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- 定义rabbitmq connectionFactory  1. 设置  publisher-confirms="true" --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>connection-factory</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.host}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.port}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.username}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.password}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">virtual-host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.virtual-host}<span class="token punctuation">"</span></span>
                               
                               <span class="token attr-name">publisher-confirms</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
                               <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--定义管理交换机、队列--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>admin</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rabbitTemplate<span class="token punctuation">"</span></span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--2. 消息可靠性投递（生产端）--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_confirm<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_confirm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>direct-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_exchange_confirm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_confirm<span class="token punctuation">"</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>confirm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>			               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>direct-exchange</span><span class="token punctuation">&gt;</span></span>
    
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div></li><li><p>编写测试代码 com.ydlclass.producer</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span>locations <span class="token operator">=</span> <span class="token string">"classpath:spring-rabbitmq-producer.xml"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 确认模式：
     * 步骤：
     * 1. 确认模式开启：ConnectionFactory中开启publisher-confirms="true"
     * 2. 在rabbitTemplate定义ConfirmCallBack回调函数
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testConfirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//2. 定义回调 **</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             *
             * <span class="token keyword">@param</span> <span class="token parameter">correlationData</span> 相关配置信息
             * <span class="token keyword">@param</span> <span class="token parameter">ack</span>   exchange交换机 是否成功收到了消息。true 成功，false代表失败
             * <span class="token keyword">@param</span> <span class="token parameter">cause</span> 失败原因
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"confirm方法被执行了...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//接收成功</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收成功消息"</span> <span class="token operator">+</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//接收失败</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收失败消息"</span> <span class="token operator">+</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//做一些处理，让消息再次发送。</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 发送消息</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"test_exchange_confirm111"</span><span class="token punctuation">,</span> <span class="token string">"confirm"</span><span class="token punctuation">,</span> <span class="token string">"message confirm...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div></li><li><p>测试结果</p><p>成功：</p><p><img src="./RabbitMQ_files/image-20220714120818639.d5d2bd3b.png" alt="image-20220714120818639" class="medium-zoom-image"></p><p>失败：</p><p><img src="./RabbitMQ_files/image-20220714120929607.e9b31074.png" alt="image-20220714120929607" class="medium-zoom-image"></p></li></ol><h4 id="_2-return退回模式代码实现" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-return%E9%80%80%E5%9B%9E%E6%A8%A1%E5%BC%8F%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" aria-hidden="true">#</a> （2） return退回模式代码实现</h4><p>回退模式： 当消息发送给Exchange后，Exchange路由到Queue失败是 才会执行 ReturnCallBack，具体实现如下：</p><ol><li><p>在 spring-rabbitmq-producer.xml 配置文件，在 <strong>rabbit:connection-factory</strong>节点 添加配置：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>publisher-returns="true"
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>编写测试方法</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 步骤：
 * 1. 开启回退模式:publisher-returns="true"
 * 2. 设置ReturnCallBack
 * 3. 设置Exchange处理消息的模式：
 *  1. 如果消息没有路由到Queue，则丢弃消息（默认）
 *  2. 如果消息没有路由到Queue，返回给消息发送方ReturnCallBack
 */</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//设置交换机处理失败消息的模式</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2.设置ReturnCallBack</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         *
         * <span class="token keyword">@param</span> <span class="token parameter">message</span>   消息对象
         * <span class="token keyword">@param</span> <span class="token parameter">replyCode</span> 错误码
         * <span class="token keyword">@param</span> <span class="token parameter">replyText</span> 错误信息
         * <span class="token keyword">@param</span> <span class="token parameter">exchange</span>  交换机
         * <span class="token keyword">@param</span> <span class="token parameter">routingKey</span> 路由键
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">returnedMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token keyword">int</span> replyCode<span class="token punctuation">,</span> <span class="token class-name">String</span> replyText<span class="token punctuation">,</span> <span class="token class-name">String</span> exchange<span class="token punctuation">,</span> <span class="token class-name">String</span> routingKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"return 执行了...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>replyCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>replyText<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//处理</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">//3. 发送消息   </span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"test_exchange_confirm"</span><span class="token punctuation">,</span> <span class="token string">"confirm"</span><span class="token punctuation">,</span> <span class="token string">"message confirm...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>设置 routingKey 为一个不符合规则的key，观察控制台打印结果。</p><p>成功：</p><p><img src="./RabbitMQ_files/image-20220714133207266.a43b3bda.png" alt="image-20220714133207266" class="medium-zoom-image"></p><p>失败：</p><p><img src="./RabbitMQ_files/image-20220714133352530.c340e440.png" alt="image-20220714133352530" class="medium-zoom-image"></p></li></ol><h4 id="_3-小结" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E5%B0%8F%E7%BB%93" aria-hidden="true">#</a> （3）小结</h4><p>对于确认模式：</p><ul><li><p>设置ConnectionFactory的publisher-confirms="true" 开启 确认模式。</p></li><li><p>使用rabbitTemplate.setConfirmCallback设置回调函数。当消息发送到exchange后回调confirm方法。在方法中判断ack，如果为true，则发送成功，如果为false，则发送失败，需要处理。</p></li></ul><p>对于退回模式</p><ul><li><p>设置ConnectionFactory的publisher-returns="true" 开启 退回模式。</p></li><li><p>使用rabbitTemplate.setReturnCallback设置退回函数，当消息从exchange路由到queue失败后，如果设置了rabbitTemplate.setMandatory(true)参数，则会将消息退回给producer。并执行回调函数returnedMessage。</p></li></ul><blockquote><p>在RabbitMQ中也提供了事务机制，但是性能较差，此处不做讲解。</p><p>使用channel列方法，完成事务控制：</p><p>txSelect(), 用于将当前channel设置成transaction模式</p><p>txCommit()，用于提交事务</p><p>txRollback(),用于回滚事务</p></blockquote><h3 id="_2、consumer-ack" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81consumer-ack" aria-hidden="true">#</a> 2、Consumer ACK</h3><p>ack指 <strong>Acknowledge</strong>，确认。 表示消费端收到消息后的确认方式。</p><p>有三种确认方式：</p><p>• 自动确认：acknowledge="<strong>none</strong>"</p><p>• 手动确认：acknowledge="<strong>manual</strong>"</p><p>• 根据异常情况确认：acknowledge="<strong>auto</strong>"，（这种方式使用麻烦，不作讲解）</p><p>其中自动确认是指，当消息一旦被Consumer接收到，则自动确认收到，并将相应 message 从 RabbitMQ 的消息缓存中移除。但是在实际业务处理中，很可能消息接收到，业务处理出现异常，那么该消息就会丢失。</p><p>如果设置了手动确认方式，则需要在业务处理成功后，调用channel.basicAck()，手动签收，如果出现异常，则调用channel.basicNack()方法，让其自动重新发送消息。</p><h4 id="_1-代码实现" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" aria-hidden="true">#</a> （1）代码实现</h4><ol><li><p>创建maven工程，消息的消费者工程，项目模块名称：rabbitmq-consumer-spring</p></li><li><p>添加依赖</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div></li><li><p>在 resources 目录下创建 rabbitmq.properties 配置文件，添加链接RabbitMQ相关信息</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">rabbitmq.host</span><span class="token punctuation">=</span><span class="token attr-value">localhost</span>
<span class="token attr-name">rabbitmq.port</span><span class="token punctuation">=</span><span class="token attr-value">5672</span>
<span class="token attr-name">rabbitmq.username</span><span class="token punctuation">=</span><span class="token attr-value">guest</span>
<span class="token attr-name">rabbitmq.password</span><span class="token punctuation">=</span><span class="token attr-value">guest</span>
<span class="token attr-name">rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token attr-value">/</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p>在 resources 目录下创建 spring-rabbitmq-consumer.xml 配置文件，添加以下配置</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>rabbit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/rabbit<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans
             http://www.springframework.org/schema/beans/spring-beans.xsd
             http://www.springframework.org/schema/context
             https://www.springframework.org/schema/context/spring-context.xsd
             http://www.springframework.org/schema/rabbit
             http://www.springframework.org/schema/rabbit/spring-rabbit.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--加载配置文件--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:rabbitmq.properties<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>connection-factory</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.host}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.port}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.username}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.password}<span class="token punctuation">"</span></span>
                               <span class="token attr-name">virtual-host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${rabbitmq.virtual-host}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.ydlclass.listener<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--定义监听器容器  添加  acknowledge="manual" 手动--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener-container</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">acknowledge</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>manual<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ackListener<span class="token punctuation">"</span></span> <span class="token attr-name">queue-names</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_confirm<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>listener-container</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div></li><li><p>编写ackListener 监听类实现ChannelAwareMessageListener接口</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">MessageListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">ChannelAwareMessageListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Consumer ACK机制：
 *  1. 设置手动签收。acknowledge="manual"
 *  2. 让监听器类实现ChannelAwareMessageListener接口
 *  3. 如果消息成功处理，则调用channel的 basicAck()签收
 *  4. 如果消息处理失败，则调用channel的basicNack()拒绝签收，broker重新发送给consumer
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AckListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//1.接收转换消息</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//2. 处理业务逻辑</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"处理业务逻辑..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//出现错误</span>
            <span class="token comment">//3. 手动签收</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//e.printStackTrace();</span>

            <span class="token comment">//4.拒绝签收</span>
            <span class="token comment">/*
            第三个参数：requeue：重回队列。如果设置为true，则消息重新回到queue，broker会重新发送该消息给消费端
             */</span>
            channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 了解</span>
            <span class="token comment">//channel.basicReject(deliveryTag,true);</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div></li><li><p>编写测试类，启动容器监听MQ队列 com.ydlclass.rabbimq</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span>locations <span class="token operator">=</span> <span class="token string">"classpath:spring-rabbitmq-consumer.xml"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ol><p><img src="./RabbitMQ_files/image-20220714135710130.04d1062b.png" alt="image-20220714135710130" class="medium-zoom-image"></p><h4 id="_2-小结" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E5%B0%8F%E7%BB%93" aria-hidden="true">#</a> （2）小结</h4><ul><li><p>在rabbit:listener-container标签中设置acknowledge属性，设置ack方式 none：自动确认，manual：手动确认</p></li><li><p>如果在消费端没有出现异常，则调用channel.basicAck(deliveryTag,false);方法确认签收消息</p></li><li><p>如果出现异常，则在catch中调用 basicNack或 basicReject，拒绝消息，让MQ重新发送消息。</p></li></ul><blockquote><p>如何保证消息的高可靠性传输？</p><p>1.持久化</p><p>• exchange要持久化</p><p>• queue要持久化</p><p>• message要持久化</p><p>2.生产方确认Confirm</p><p>3.消费方确认Ack</p><p>4.Broker高可用</p></blockquote><h3 id="_3、消费端限流" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%99%90%E6%B5%81" aria-hidden="true">#</a> 3、消费端限流</h3><p><img src="./RabbitMQ_files/1569164559749.a1e921d8.png" alt="1569164559749" class="medium-zoom-image"></p><p>如上图所示：如果在A系统中需要维护相关的业务功能，可能需要将A系统的服务停止，那么这个时候消息的生产者还是一直会向MQ中发送待处理的消息，消费者此时服务已经关闭，导致大量的消息都会在MQ中累积。如果当A系统成功启动后，默认情况下消息的消费者会一次性将MQ中累积的大量的消息全部拉取到自己的服务，导致服务在短时间内会处理大量的业务，可能会导致系统服务的崩溃。 所以消费端限流是非常有必要的。</p><p>可以通过MQ中的 listener-container 配置属性 perfetch = 1,表示消费端每次从mq拉去一条消息来消费，直到手动确认消费完毕后，才会继续拉去下一条消息。</p><h4 id="_1-代码实现-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1" aria-hidden="true">#</a> （1）代码实现</h4><ol><li><p>编写 QosListener 监听类，保证当前的监听类消息处理机制是 ACK 为手动方式</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QosListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//1.获取消息</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 处理业务逻辑</span>
        <span class="token comment">//3. 签收</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li><li><p>在配置文件的 listener-container 配置属性中添加配置</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener-container</span> <span class="token attr-name">connection-factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>connectionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">acknowledge</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>manual<span class="token punctuation">"</span></span> <span class="token attr-name">prefetch</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>
    
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>qosListener<span class="token punctuation">"</span></span> <span class="token attr-name">queue-names</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_confirm<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>配置说明：</p><p>perfetch = 1,表示消费端每次从mq拉去一条消息来消费，直到手动确认消费完毕后，才会继续拉去下一条消息。</p></blockquote></li></ol><p>3.生产者，连发10条消息.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>    @Test
    public void testSend() {
        for (int i = 0; i &lt; 10; i++) {
            //发送消息
            rabbitTemplate.convertAndSend("test_exchange_confirm", "confirm", "message confirm....");
        }
    }
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_2-小结-1" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E5%B0%8F%E7%BB%93-1" aria-hidden="true">#</a> （2）小结</h4><ul><li><p>在<a href="rabbit:listener-container">rabbit:listener-container</a> 中配置 prefetch属性设置消费端一次拉取多少消息</p></li><li><p>消费端的确认模式一定为手动确认。acknowledge="manual"</p></li></ul><h3 id="_4、ttl" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4%E3%80%81ttl" aria-hidden="true">#</a> 4、TTL</h3><p>设置队列参数、交换机参数、发消息都可以用页面。</p><p>也能用代码。</p><p>TTL 全称 Time To Live（存活时间/过期时间）。当消息到达存活时间后，还没有被消费，会被自动清除。</p><p>RabbitMQ可以对消息设置过期时间，也可以对整个队列（Queue）设置过期时间。</p><p><img src="./RabbitMQ_files/1569166173852.55444692.png" alt="1569166173852" class="medium-zoom-image"></p><p>可以在RabbitMQ管理控制台设置过期时间，此处不做重点讲解。</p><p><strong>一起做一下</strong>：</p><p>创建队列 test_queue_ttl 设置ttl为10秒</p><p><img src="./RabbitMQ_files/image-20200321000505022.3d21d748.png" alt="image-20200321000505022" class="medium-zoom-image"></p><p>创建交换机test_exchange_ttl 绑定 队列</p><p><img src="./RabbitMQ_files/image-20200321000710192.0dad458c.png" alt="image-20200321000710192" class="medium-zoom-image"></p><p><img src="./RabbitMQ_files/image-20220714141856963.34e53d20.png" alt="image-20220714141856963" class="medium-zoom-image"></p><p>向交换机发一个消息</p><p><img src="./RabbitMQ_files/image-20220714142043712.98552c4c.png" alt="image-20220714142043712" class="medium-zoom-image"></p><p>查看队列消息，过10秒删除</p><p><img src="./RabbitMQ_files/image-20220714142021614.3081f2f6.png" alt="image-20220714142021614" class="medium-zoom-image"></p><h4 id="_1-代码实现-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-2" aria-hidden="true">#</a> （1）代码实现</h4><h5 id="a、设置队列的过期时间" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#a%E3%80%81%E8%AE%BE%E7%BD%AE%E9%98%9F%E5%88%97%E7%9A%84%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4" aria-hidden="true">#</a> a、设置队列的过期时间</h5><ol><li><p>在消息的生产方中，在 spring-rabbitmq-producer.xml 配置文件中，添加如下配置：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--ttl--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_ttl<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_ttl<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--设置queue的参数--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--x-message-ttl指队列的过期时间--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x-message-ttl<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10000<span class="token punctuation">"</span></span> <span class="token attr-name">value-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.Integer<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_exchange_ttl<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ydl.#<span class="token punctuation">"</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_ttl<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li><li><p>编写发送消息测试方法</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ttlTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"test_exchange_ttl"</span><span class="token punctuation">,</span><span class="token string">"ydl.itlils"</span><span class="token punctuation">,</span><span class="token string">"hello ttl"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>测试结果：当消息发送成功后，过10s后在RabbitMQ的管理控制台会看到消息会自动删除。</p></li></ol><p><img src="./RabbitMQ_files/image-20220714142521691.9ddf683b.png" alt="image-20220714142521691" class="medium-zoom-image"></p><h5 id="b、设置单个消息的过期时间" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#b%E3%80%81%E8%AE%BE%E7%BD%AE%E5%8D%95%E4%B8%AA%E6%B6%88%E6%81%AF%E7%9A%84%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4" aria-hidden="true">#</a> b、设置单个消息的过期时间</h5><p>编写代码测试，并且设置队列的过期时间为10s， 单个消息的过期时间为5s</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTtl2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 消息后处理对象，设置一些消息的参数信息</span>
        <span class="token class-name">MessagePostProcessor</span> messagePostProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessagePostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Message</span> <span class="token function">postProcessMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AmqpException</span> <span class="token punctuation">{</span>
                <span class="token comment">//1.设置message的信息</span>
                message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token string">"5000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消息的过期时间</span>
                <span class="token comment">//2.返回该消息</span>
                <span class="token keyword">return</span> message<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">//消息单独过期</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"test_exchange_ttl"</span><span class="token punctuation">,</span>
                <span class="token string">"ttl.hehe"</span><span class="token punctuation">,</span> <span class="token string">"message ttl...."</span><span class="token punctuation">,</span>messagePostProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//消息单独过期</span>
                rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"test_exchange_ttl"</span><span class="token punctuation">,</span> <span class="token string">"ttl.hehe"</span><span class="token punctuation">,</span> <span class="token string">"message ttl...."</span><span class="token punctuation">,</span>messagePostProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token comment">//不过期的消息</span>
                rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"test_exchange_ttl"</span><span class="token punctuation">,</span> <span class="token string">"ttl.hehe"</span><span class="token punctuation">,</span> <span class="token string">"message ttl...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><blockquote><p>如果设置了消息的过期时间，也设置了队列的过期时间，它以时间短的为准。</p><ul><li>队列过期后，会将队列所有消息全部移除。</li><li>消息过期后，只有消息在队列顶端，才会判断其是否过期(移除掉)</li></ul></blockquote><p>5s</p><p><img src="./RabbitMQ_files/image-20220714143016960.7b954414.png" alt="image-20220714143016960" class="medium-zoom-image"></p><p>20s</p><p><img src="./RabbitMQ_files/image-20220714143257013.53b83dc2.png" alt="image-20220714143257013" class="medium-zoom-image"></p><p>5 10 5 10</p><p><img src="./RabbitMQ_files/image-20220714143611629.d8ef4d4d.png" alt="image-20220714143611629" class="medium-zoom-image"></p><h4 id="_2-小结-2" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E5%B0%8F%E7%BB%93-2" aria-hidden="true">#</a> （2）小结</h4><ul><li><p>设置队列过期时间使用参数：x-message-ttl，单位：ms(毫秒)，会对整个队列消息统一过期。</p></li><li><p>设置消息过期时间使用参数：expiration。单位：ms(毫秒)，当该消息在队列头部时（消费时），会单独判断这一消息是否过期。</p></li><li><p>如果两者都进行了设置，以时间短的为准。</p></li></ul><h3 id="_5、死信队列" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5%E3%80%81%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97" aria-hidden="true">#</a> 5、死信队列</h3><p>死信队列，英文缩写：DLX 。Dead Letter Exchange（死信交换机），当消息成为Dead message后，可以被重新发送到另一个交换机，这个交换机就是DLX。</p><p><img src="./RabbitMQ_files/1569167524589.ebc81648.png" alt="1569167524589" class="medium-zoom-image"></p><p><strong>消息成为死信的三种情况：</strong></p><ol><li><p>队列消息长度到达限制；</p></li><li><p>消费者拒接消费消息，basicNack/basicReject,并且不把消息重新放入原目标队列,requeue=false；</p></li><li><p>原队列存在消息过期设置，消息到达超时时间未被消费；</p></li></ol><p><strong>队列绑定死信交换机：</strong></p><p>给队列设置参数： x-dead-letter-exchange 和 x-dead-letter-routing-key</p><p><img src="./RabbitMQ_files/1569167616750.b353ac0d.png" alt="1569167616750" class="medium-zoom-image"></p><h4 id="_1-代码实现-3" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-3" aria-hidden="true">#</a> （1）代码实现</h4><ol><li><p>在消息的生产方中，在 spring-rabbitmq-producer.xml 配置文件中，添加如下配置：</p><ul><li><p>声明正常的队列(test_queue_dlx)和交换机(test_exchange_dlx)</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_dlx<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_exchange_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test.dlx.#<span class="token punctuation">"</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li><li><p>声明死信队列(queue_dlx)和死信交换机(exchange_dlx)</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>queue_dlx<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>queue_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>exchange_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dlx.#<span class="token punctuation">"</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>queue_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>正常队列绑定死信交换机，并设置相关参数信息</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_dlx<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--3. 正常队列绑定死信交换机--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--3.1 x-dead-letter-exchange：死信交换机名称--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x-dead-letter-exchange<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>exchange_dlx<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

        <span class="token comment">&lt;!--3.2 x-dead-letter-routing-key：发送给死信交换机的routingkey--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x-dead-letter-routing-key<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dlx.hehe<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

        <span class="token comment">&lt;!--4.1 设置队列的过期时间 ttl--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x-message-ttl<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10000<span class="token punctuation">"</span></span> <span class="token attr-name">value-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.Integer<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!--4.2 设置队列的长度限制 max-length --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x-max-length<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">value-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.Integer<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_exchange_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test.dlx.#<span class="token punctuation">"</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li></ul></li><li><p>编写测试方法</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 发送测试死信消息：
     *  1. 过期时间
     *  2. 长度限制
     *  3. 消息拒收
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDlx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//1. 测试过期时间，死信消息</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"test_exchange_dlx"</span><span class="token punctuation">,</span>
                                      <span class="token string">"test.dlx.haha"</span><span class="token punctuation">,</span><span class="token string">"我是一条消息，我会死吗？"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2. 测试长度限制后，消息死信</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"test_exchange_dlx"</span><span class="token punctuation">,</span>
                                          <span class="token string">"test.dlx.haha"</span><span class="token punctuation">,</span><span class="token string">"我是一条消息，我会死吗？"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//3. 测试消息拒收</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"test_exchange_dlx"</span><span class="token punctuation">,</span>
                                      <span class="token string">"test.dlx.haha"</span><span class="token punctuation">,</span><span class="token string">"我是一条消息，我会死吗？"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></li></ol><p>3消息拒绝接受消费者增加监听</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * creste by ydlclass.itcast
 */</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">ChannelAwareMessageListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Consumer ACK机制：
 *  1. 设置手动签收。acknowledge="manual"
 *  2. 让监听器类实现ChannelAwareMessageListener接口
 *  3. 如果消息成功处理，则调用channel的 basicAck()签收
 *  4. 如果消息处理失败，则调用channel的basicNack()拒绝签收，broker重新发送给consumer
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DlxListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//1.接收转换消息</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//2. 处理业务逻辑</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"处理业务逻辑..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//出现错误</span>
            <span class="token comment">//3. 手动签收</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//e.printStackTrace();</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"拒绝接受"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.拒绝签收</span>
            <span class="token comment">/*
            第三个参数：requeue：重回队列。如果设置为true，则消息重新回到queue，broker会重新发送该消息给消费端
             */</span>
            channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 了解</span>
            <span class="token comment">//channel.basicReject(deliveryTag,true);</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>配置文件</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>listener</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dlxListener<span class="token punctuation">"</span></span> <span class="token attr-name">queue-names</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_queue_dlx<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h4 id="_2-小结-3" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E5%B0%8F%E7%BB%93-3" aria-hidden="true">#</a> （2）小结</h4><ol><li><p>死信交换机和死信队列和普通的没有区别</p></li><li><p>当消息成为死信后，如果该队列绑定了死信交换机，则消息会被死信交换机重新路由到死信队列</p></li><li><p>消息成为死信的三种情况：</p><ul><li><p>队列消息长度到达限制；</p></li><li><p>消费者拒接消费消息，并且不重回队列；</p></li><li><p>原队列存在消息过期设置，消息到达超时时间未被消费；</p></li></ul></li></ol><h3 id="_6、延迟队列-重点" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_6%E3%80%81%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97-%E9%87%8D%E7%82%B9" aria-hidden="true">#</a> 6、延迟队列-重点</h3><p>延迟队列，即消息进入队列后不会立即被消费，只有到达指定时间后，才会被消费。</p><p>提出需求：</p><ol><li><p>下单后，30分钟未支付，取消订单，回滚库存。</p></li><li><p>新用户注册成功7天后，发送短信问候。</p></li></ol><p>实现方式：</p><ol><li><p>定时器（不优雅！）</p></li><li><p>延迟队列</p></li></ol><p><img src="./RabbitMQ_files/1569168202661.c342efd8.png" alt="1569168202661" class="medium-zoom-image"></p><p>注意：在RabbitMQ中并未提供延迟队列功能。</p><p>但是可以使用：<strong>TTL+死信队列</strong> 组合实现延迟队列的效果。</p><p><img src="./RabbitMQ_files/1569168255196.be484518.png" alt="1569168255196" class="medium-zoom-image"></p><h4 id="_1-代码实现-4" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-4" aria-hidden="true">#</a> （1）代码实现</h4><ol><li><p>在消息的生产方中，在 spring-rabbitmq-producer.xml 配置文件中，添加如下配置：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- 1. 定义正常交换机（order_exchange）和队列(order_queue)--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_queue<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_queue<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 3. 绑定，设置正常队列过期时间为30分钟--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x-dead-letter-exchange<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_exchange_dlx<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x-dead-letter-routing-key<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dlx.order.cancel<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x-message-ttl<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10000<span class="token punctuation">"</span></span> <span class="token attr-name">value-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.Integer<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue-arguments</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_exchange<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order.#<span class="token punctuation">"</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_queue<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--  2. 定义死信交换机（order_exchange_dlx）和队列(order_queue_dlx)--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>queue</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_queue_dlx<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_queue_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>queue</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>topic-exchange</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_exchange_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rabbit:</span>binding</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dlx.order.#<span class="token punctuation">"</span></span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_queue_dlx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>binding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>bindings</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rabbit:</span>topic-exchange</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></li><li><p>编写测试方法</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">testDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1.发送订单消息。 将来是在订单系统中，下单成功后，发送消息</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"order_exchange"</span><span class="token punctuation">,</span>
                                  <span class="token string">"order.msg"</span><span class="token punctuation">,</span><span class="token string">"订单信息：id=1,time=2022年"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2.打印倒计时10秒</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li></ol><p>3消费者</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydlclass<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * creste by ydlclass.itcast
 */</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">ChannelAwareMessageListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Consumer ACK机制：
 *  1. 设置手动签收。acknowledge="manual"
 *  2. 让监听器类实现ChannelAwareMessageListener接口
 *  3. 如果消息成功处理，则调用channel的 basicAck()签收
 *  4. 如果消息处理失败，则调用channel的basicNack()拒绝签收，broker重新发送给consumer
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//1.接收转换消息</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//2. 处理业务逻辑</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"处理业务逻辑..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"查询数据库。。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"查看支付状态。。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//3. 手动签收</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//e.printStackTrace();</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"拒绝接受"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.拒绝签收</span>
            <span class="token comment">/*
            第三个参数：requeue：重回队列。如果设置为true，则消息重新回到queue，broker会重新发送该消息给消费端
             */</span>
            channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 了解</span>
            <span class="token comment">//channel.basicReject(deliveryTag,true);</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>配置文件</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;rabbit:listener ref="orderListener" queue-names="order_queue_dlx"/&gt;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h4 id="_2-小结-4" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E5%B0%8F%E7%BB%93-4" aria-hidden="true">#</a> （2） 小结</h4><ol><li><p>延迟队列 指消息进入队列后，可以被延迟一定时间，再进行消费。</p></li><li><p>RabbitMQ没有提供延迟队列功能，但是可以使用 ： <strong>TTL + DLX</strong> 来实现延迟队列效果。</p></li></ol><h3 id="_7、日志与监控-了解" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_7%E3%80%81%E6%97%A5%E5%BF%97%E4%B8%8E%E7%9B%91%E6%8E%A7-%E4%BA%86%E8%A7%A3" aria-hidden="true">#</a> 7、日志与监控-了解</h3><h4 id="_1-rabbitmq日志" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-rabbitmq%E6%97%A5%E5%BF%97" aria-hidden="true">#</a> （1）RabbitMQ日志</h4><p>RabbitMQ默认日志存放路径：</p><p>​ Linux 下/var /log/rabbitmq/rabbit@xxx.log</p><p>​ windows下C:\Users\Administrator\AppData\Roaming\RabbitMQ\log</p><p>RabbitMQ 日志所在的目录：</p><p><img src="./RabbitMQ_files/1569168718549.49512116.png" alt="1569168718549" class="medium-zoom-image"></p><p>RabbitMQ日志详细信息：</p><p>日志包含了RabbitMQ的版本号、Erlang的版本号、RabbitMQ服务节点名称、cookie的hash值、RabbitMQ配置文件地址、内存限制、磁盘限制、默认账户guest的创建以及权限配置等等。</p><p><img src="./RabbitMQ_files/image-20220714151931414.b29a5e65.png" alt="image-20220714151931414" class="medium-zoom-image"></p><h4 id="_2-web管控台监控" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-web%E7%AE%A1%E6%8E%A7%E5%8F%B0%E7%9B%91%E6%8E%A7" aria-hidden="true">#</a> （2）web管控台监控</h4><p><strong>注意windows下</strong>：进入sbin目录，命令后加“.bat”。如rabbitmqctl.bat</p><p>直接访问当前的IP:15672，输入用户名和密码（默认是 guest），就可以查看RabbitMQ的管理控制台。当然也可通过命令的形式来查看。如下：</p><ul><li><p>查看队列：rabbitmqctl list_queues</p><p>对应管理控制台的页面如下：</p><p><img src="./RabbitMQ_files/image-20220714152127778.fc84dbcc.png" alt="image-20220714152127778" class="medium-zoom-image"></p></li><li><p>查看用户： rabbitmqctl list_users</p></li><li><p>查看连接：rabbitmqctl list_connections</p></li></ul><blockquote><p>其它相关命令（了解）：</p><p>查看exchanges：rabbitmqctl list_exchanges</p><p>查看消费者信息：rabbitmqctl list_consumers</p><p>查看环境变量：rabbitmqctl environment</p><p>查看未被确认的队列：rabbitmqctl list_queues name messages_unacknowledged</p><p>查看单个队列的内存使用：rabbitmqctl list_queues name memory</p><p>查看准备就绪的队列：rabbitmqctl list_queues name messages_ready</p></blockquote><h3 id="_8、消息追踪-了解" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_8%E3%80%81%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA-%E4%BA%86%E8%A7%A3" aria-hidden="true">#</a> 8、消息追踪-了解</h3><p>在使用任何消息中间件的过程中，难免会出现某条消息异常丢失的情况。对于RabbitMQ而言，可能是因为生产者或消费者与RabbitMQ断开了连接，而它们与RabbitMQ又采用了不同的确认机制；也有可能是因为交换器与队列之间不同的转发策略；甚至是交换器并没有与任何队列进行绑定，生产者又不感知或者没有采取相应的措施；另外RabbitMQ本身的集群策略也可能导致消息的丢失。这个时候就需要有一个较好的机制跟踪记录消息的投递过程，以此协助开发和运维人员进行问题的定位。</p><p>在RabbitMQ中可以使用Firehose和rabbitmq_tracing插件功能来实现消息追踪。</p><h4 id="_1-消息追踪-firehose" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA-firehose" aria-hidden="true">#</a> （1）消息追踪-Firehose</h4><p>firehose的机制是将生产者投递给rabbitmq的消息，rabbitmq投递给消费者的消息按照指定的格式发送到默认的exchange上。这个默认的exchange的名称为 <strong>amq.rabbitmq.trace</strong>，它是一个<strong>topic</strong>类型的<strong>exchange</strong>。发送到这个exchange上的消息的routing key为 publish.exchangename 和 deliver.queuename。其中exchangename和queuename为实际exchange和queue的名称，分别对应生产者投递到exchange的消息，和消费者从queue上获取的消息。</p><p><img src="./RabbitMQ_files/1569201204959.dde46343.png" alt="1569201204959" class="medium-zoom-image"></p><p><strong>注意：打开 trace 会影响消息写入功能，适当打开后请关闭。</strong></p><p>rabbitmqctl trace_on：开启Firehose命令</p><p><strong>消息追踪验证：</strong></p><ol><li><p>创建一个队列 <strong>test_trace</strong>，并将当前的队列绑定到 <strong>amq.rabbitmq.trace</strong> 交换机上，设置RoutingKey为：<strong>#</strong></p><p><img src="./RabbitMQ_files/1569201672175.736f2200.png" alt="1569201672175" class="medium-zoom-image"></p></li><li><p>未开启消息追踪之前，我们发送一个消息</p><p><img src="./RabbitMQ_files/1569201776723.7acd3ef5.png" alt="1569201776723" class="medium-zoom-image"></p><p>当前消息发送成功后，在控制台我们可以看到当前消息的具体信息</p></li><li><p>设置<strong>开启消息追踪</strong>，在发送一条消息</p><p><img src="./RabbitMQ_files/1569201317013.397a5f8c.png" alt="1569201317013" class="medium-zoom-image"></p><p>完整的消息内容：</p><p><img src="./RabbitMQ_files/1569202059745.3d93708c.png" alt="1569202059745" class="medium-zoom-image"></p></li></ol><p>我们发现当前消息也正常存在，并且开启消息追踪后，会多出一条消息是 <strong>amq.rabbitmq.trace</strong> 交换机发给当前队列的消息，消息中的内容是比较完整的。</p><blockquote><p>建议：在开发阶段我们可以开启消息追踪，在实际生产环境建议将其关闭</p><p>rabbitmqctl trace_off：关闭Firehose命令</p></blockquote><h4 id="_2-消息追踪-rabbitmq-tracing" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA-rabbitmq-tracing" aria-hidden="true">#</a> （2） 消息追踪-rabbitmq_tracing</h4><p>rabbitmq_tracing和Firehose在实现上如出一辙，只不过rabbitmq_tracing的方式比Firehose多了一层GUI的包装，更容易使用和管理。</p><p>启用插件：rabbitmq-plugins enable rabbitmq_tracing</p><p><img src="./RabbitMQ_files/1569202861087.f0450a8a.png" alt="1569202861087" class="medium-zoom-image"></p><p>发送消息成功后，我们点击日志文件，要求输入RabbitMQ的登录用户名和密码。</p><p><img src="./RabbitMQ_files/1569203000215.8bca3152.png" alt="1569203000215" class="medium-zoom-image"></p><blockquote><p>建议：在开发阶段我们可以开启消息追踪插件，在实际生产环境不建议建议开启，除非是非常特殊的业务场景，大家根据实际情况选择开启即可。</p></blockquote><h2 id="第二章-rabbitmq应用问题-面试" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#%E7%AC%AC%E4%BA%8C%E7%AB%A0-rabbitmq%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98-%E9%9D%A2%E8%AF%95" aria-hidden="true">#</a> 第二章 RabbitMQ应用问题-面试</h2><h3 id="_1、消息可靠性保障" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BF%9D%E9%9A%9C" aria-hidden="true">#</a> 1、消息可靠性保障</h3><p>提出需求：如何能够保证消息的 100% 发送成功？</p><p>首先大家要明确任何一个系统都不能保证消息的 100% 投递成功，我们是可以保证消息以最高最可靠的发送给目标方。</p><p>在RabbitMQ中采用 <strong>消息补充机制</strong> 来保证消息的可靠性</p><p><img src="./RabbitMQ_files/1569203830553.89c61c65.png" alt="1569203830553" class="medium-zoom-image"></p><p>消息勾兑</p><p>步骤分析：</p><p>参与部分：消息生产者、消息消费者、数据库、三个队列（Q1、Q2、Q3）、交换机、回调检查服务、定时检查服务</p><ol><li>消息的生产者将业务数据存到数据库中</li><li>发送消息给 队列Q1</li><li>消息的生产者等待一定的时间后，在发送一个延迟消息给队列 Q3</li><li>消息的消费方监听 Q1 队列消息，成功接收后</li><li>消息的消费方会 发送 一条确认消息给 队列Q2</li><li>回调检查服务监听 队列Q2 发送的确认消息</li><li>回调检查服务接收到确认消息后，将消息写入到 消息的数据库表中</li><li>回调检查服务同时也会监听 队列Q3延迟消息， 如果接收到消息会和数据库比对消息的唯一标识</li><li>如果发现没有接收到确认消息，那么回调检查服务就会远程调用 消息生产者，重新发送消息</li><li>重新执行 2-7 步骤，保证消息的可靠性传输</li><li>如果发送消息和延迟消息都出现异常，定时检查服务会监控 消息库中的消息数据，如果发现不一致的消息然后远程调用消息的生产者重新发送消息。</li></ol><h3 id="_2、-消息幂等性处理" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2%E3%80%81-%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7%E5%A4%84%E7%90%86" aria-hidden="true">#</a> 2、 消息幂等性处理</h3><p>幂等性指一次和多次请求某一个资源，对于资源本身应该具有同样的结果。也就是说，其任意多次执行对资源本身所产生的影响均与一次执行的影响相同。</p><p>在MQ中指，消费多条相同的消息，得到与消费该消息一次相同的结果。</p><p>在本教程中使用 <strong>乐观锁机制</strong> 保证消息的幂等操作</p><p><img src="./RabbitMQ_files/1569210134160.47cd8c5d.png" alt="1569210134160" class="medium-zoom-image"></p><h3 id="_3、rabbitmq集群搭建-运维" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3%E3%80%81rabbitmq%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-%E8%BF%90%E7%BB%B4" aria-hidden="true">#</a> 3、RabbitMQ集群搭建-运维</h3><p>摘要：实际生产应用中都会采用消息队列的集群方案，如果选择RabbitMQ那么有必要了解下它的集群方案原理</p><p>一般来说，如果只是为了学习RabbitMQ或者验证业务工程的正确性那么在本地环境或者测试环境上使用其单实例部署就可以了，但是出于MQ中间件本身的可靠性、并发性、吞吐量和消息堆积能力等问题的考虑，在生产环境上一般都会考虑使用RabbitMQ的集群方案。</p><h4 id="_1-集群方案的原理" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_1-%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88%E7%9A%84%E5%8E%9F%E7%90%86" aria-hidden="true">#</a> （1） 集群方案的原理</h4><p>RabbitMQ这款消息队列中间件产品本身是基于Erlang编写，Erlang语言天生具备分布式特性（通过同步Erlang集群各节点的magic cookie来实现）。因此，RabbitMQ天然支持Clustering。这使得RabbitMQ本身不需要像ActiveMQ、Kafka那样通过ZooKeeper分别来实现HA方案和保存集群的元数据。集群是保证可靠性的一种方式，同时可以通过水平扩展以达到增加消息吞吐量能力的目的。</p><p><img src="./RabbitMQ_files/1566073768274.20ab1d25.png" alt="1565245219265" class="medium-zoom-image"></p><h4 id="_2-单机多实例部署" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_2-%E5%8D%95%E6%9C%BA%E5%A4%9A%E5%AE%9E%E4%BE%8B%E9%83%A8%E7%BD%B2" aria-hidden="true">#</a> （2）单机多实例部署</h4><p>由于某些因素的限制，有时候你不得不在一台机器上去搭建一个rabbitmq集群，这个有点类似zookeeper的单机版。真实生成环境还是要配成多机集群的。有关怎么配置多机集群的可以参考其他的资料，这里主要论述如何在单机中配置多个rabbitmq实例。</p><p>主要参考官方文档：https://www.rabbitmq.com/clustering.html</p><p>首先确保RabbitMQ运行没有问题</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl status</span>
Status of node rabbit@super <span class="token punctuation">..</span>.
<span class="token punctuation">[</span><span class="token punctuation">{</span>pid,10232<span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>running_applications,
     <span class="token punctuation">[</span><span class="token punctuation">{</span>rabbitmq_management,<span class="token string">"RabbitMQ Management Console"</span>,<span class="token string">"3.6.5"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>rabbitmq_web_dispatch,<span class="token string">"RabbitMQ Web Dispatcher"</span>,<span class="token string">"3.6.5"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>webmachine,<span class="token string">"webmachine"</span>,<span class="token string">"1.10.3"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>mochiweb,<span class="token string">"MochiMedia Web Server"</span>,<span class="token string">"2.13.1"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>rabbitmq_management_agent,<span class="token string">"RabbitMQ Management Agent"</span>,<span class="token string">"3.6.5"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>rabbit,<span class="token string">"RabbitMQ"</span>,<span class="token string">"3.6.5"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>os_mon,<span class="token string">"CPO  CXC 138 46"</span>,<span class="token string">"2.4"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>syntax_tools,<span class="token string">"Syntax tools"</span>,<span class="token string">"1.7"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>inets,<span class="token string">"INETS  CXC 138 49"</span>,<span class="token string">"6.2"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>amqp_client,<span class="token string">"RabbitMQ AMQP Client"</span>,<span class="token string">"3.6.5"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>rabbit_common,<span class="token punctuation">[</span><span class="token punctuation">]</span>,<span class="token string">"3.6.5"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>ssl,<span class="token string">"Erlang/OTP SSL application"</span>,<span class="token string">"7.3"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>public_key,<span class="token string">"Public key infrastructure"</span>,<span class="token string">"1.1.1"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>asn1,<span class="token string">"The Erlang ASN1 compiler version 4.0.2"</span>,<span class="token string">"4.0.2"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>ranch,<span class="token string">"Socket acceptor pool for TCP protocols."</span>,<span class="token string">"1.2.1"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>mnesia,<span class="token string">"MNESIA  CXC 138 12"</span>,<span class="token string">"4.13.3"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>compiler,<span class="token string">"ERTS  CXC 138 10"</span>,<span class="token string">"6.0.3"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>crypto,<span class="token string">"CRYPTO"</span>,<span class="token string">"3.6.3"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>xmerl,<span class="token string">"XML parser"</span>,<span class="token string">"1.3.10"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>sasl,<span class="token string">"SASL  CXC 138 11"</span>,<span class="token string">"2.7"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>stdlib,<span class="token string">"ERTS  CXC 138 10"</span>,<span class="token string">"2.8"</span><span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>kernel,<span class="token string">"ERTS  CXC 138 10"</span>,<span class="token string">"4.2"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>os,<span class="token punctuation">{</span>unix,linux<span class="token punctuation">}</span><span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>erlang_version,
     <span class="token string">"Erlang/OTP 18 [erts-7.3] [source] [64-bit] [async-threads:64] [hipe] [kernel-poll:true]<span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>memory,
     <span class="token punctuation">[</span><span class="token punctuation">{</span>total,56066752<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>connection_readers,0<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>connection_writers,0<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>connection_channels,0<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>connection_other,2680<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>queue_procs,268248<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>queue_slave_procs,0<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>plugins,1131936<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>other_proc,18144280<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>mnesia,125304<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>mgmt_db,921312<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>msg_index,69440<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>other_ets,1413664<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>binary,755736<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>code,27824046<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>atom,1000601<span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>other_system,4409505<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>alarms,<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>listeners,<span class="token punctuation">[</span><span class="token punctuation">{</span>clustering,25672,<span class="token string">"::"</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>amqp,5672,<span class="token string">"::"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>vm_memory_high_watermark,0.4<span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>vm_memory_limit,411294105<span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>disk_free_limit,50000000<span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>disk_free,13270233088<span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>file_descriptors,
     <span class="token punctuation">[</span><span class="token punctuation">{</span>total_limit,924<span class="token punctuation">}</span>,<span class="token punctuation">{</span>total_used,6<span class="token punctuation">}</span>,<span class="token punctuation">{</span>sockets_limit,829<span class="token punctuation">}</span>,<span class="token punctuation">{</span>sockets_used,0<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>processes,<span class="token punctuation">[</span><span class="token punctuation">{</span>limit,1048576<span class="token punctuation">}</span>,<span class="token punctuation">{</span>used,262<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>run_queue,0<span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>uptime,43651<span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>kernel,<span class="token punctuation">{</span>net_ticktime,60<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>停止rabbitmq服务</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@super sbin<span class="token punctuation">]</span><span class="token comment"># service rabbitmq-server stop</span>
Stopping rabbitmq-server: rabbitmq-server.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>启动第一个节点：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@super sbin<span class="token punctuation">]</span><span class="token comment"># RABBITMQ_NODE_PORT=5673 RABBITMQ_NODENAME=rabbit1 rabbitmq-server start</span>

              RabbitMQ <span class="token number">3.6</span>.5. Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2007</span>-2016 Pivotal Software, Inc.
  <span class="token comment">##  ##      Licensed under the MPL.  See http://www.rabbitmq.com/</span>
  <span class="token comment">##  ##</span>
  <span class="token comment">##########  Logs: /var/log/rabbitmq/rabbit1.log</span>
  <span class="token comment">######  ##        /var/log/rabbitmq/rabbit1-sasl.log</span>
  <span class="token comment">##########</span>
              Starting broker<span class="token punctuation">..</span>.
 completed with <span class="token number">6</span> plugins.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>启动第二个节点：</p><blockquote><p>web管理插件端口占用,所以还要指定其web插件占用的端口号。</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># RABBITMQ_NODE_PORT=5674 RABBITMQ_SERVER_START_ARGS="-rabbitmq_management listener [{port,15674}]" RABBITMQ_NODENAME=rabbit2 rabbitmq-server start</span>

              RabbitMQ <span class="token number">3.6</span>.5. Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2007</span>-2016 Pivotal Software, Inc.
  <span class="token comment">##  ##      Licensed under the MPL.  See http://www.rabbitmq.com/</span>
  <span class="token comment">##  ##</span>
  <span class="token comment">##########  Logs: /var/log/rabbitmq/rabbit2.log</span>
  <span class="token comment">######  ##        /var/log/rabbitmq/rabbit2-sasl.log</span>
  <span class="token comment">##########</span>
              Starting broker<span class="token punctuation">..</span>.
 completed with <span class="token number">6</span> plugins.

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>结束命令：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>rabbitmqctl -n rabbit1 stop
rabbitmqctl -n rabbit2 stop
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>rabbit1操作作为主节点：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl -n rabbit1 stop_app  </span>
Stopping node rabbit1@super <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl -n rabbit1 reset	 </span>
Resetting node rabbit1@super <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl -n rabbit1 start_app</span>
Starting node rabbit1@super <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># </span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>rabbit2操作为从节点：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl -n rabbit2 stop_app</span>
Stopping node rabbit2@super <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl -n rabbit2 reset</span>
Resetting node rabbit2@super <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl -n rabbit2 join_cluster rabbit1@'super' ###''内是主机名换成自己的</span>
Clustering node rabbit2@super with rabbit1@super <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@super ~<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl -n rabbit2 start_app</span>
Starting node rabbit2@super <span class="token punctuation">..</span>.

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>查看集群状态：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[root@super ~]# rabbitmqctl cluster_status -n rabbit1
Cluster status of node rabbit1@super ...
[{nodes,[{disc,[rabbit1@super,rabbit2@super]}]},
 {running_nodes,[rabbit2@super,rabbit1@super]},
 {cluster_name,&lt;&lt;"rabbit1@super"&gt;&gt;},
 {partitions,[]},
 {alarms,[{rabbit2@super,[]},{rabbit1@super,[]}]}]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>web监控：</p><p><img src="./RabbitMQ_files/1566065096459.f6a3b079.png" alt="1566065096459" class="medium-zoom-image"></p><h4 id="_3-集群管理" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_3-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86" aria-hidden="true">#</a> （3）集群管理</h4><p><strong>rabbitmqctl join_cluster {cluster_node} [–ram]</strong> 将节点加入指定集群中。在这个命令执行前需要停止RabbitMQ应用并重置节点。</p><p><strong>rabbitmqctl cluster_status</strong> 显示集群的状态。</p><p><strong>rabbitmqctl change_cluster_node_type {disc|ram}</strong> 修改集群节点的类型。在这个命令执行前需要停止RabbitMQ应用。</p><p><strong>rabbitmqctl forget_cluster_node [–offline]</strong> 将节点从集群中删除，允许离线执行。</p><p><strong>rabbitmqctl update_cluster_nodes {clusternode}</strong></p><p>在集群中的节点应用启动前咨询clusternode节点的最新信息，并更新相应的集群信息。这个和join_cluster不同，它不加入集群。考虑这样一种情况，节点A和节点B都在集群中，当节点A离线了，节点C又和节点B组成了一个集群，然后节点B又离开了集群，当A醒来的时候，它会尝试联系节点B，但是这样会失败，因为节点B已经不在集群中了。</p><p><strong>rabbitmqctl cancel_sync_queue [-p vhost] {queue}</strong> 取消队列queue同步镜像的操作。</p><p><strong>rabbitmqctl set_cluster_name {name}</strong> 设置集群名称。集群名称在客户端连接时会通报给客户端。Federation和Shovel插件也会有用到集群名称的地方。集群名称默认是集群中第一个节点的名称，通过这个命令可以重新设置。</p><h4 id="_4-rabbitmq镜像集群配置" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_4-rabbitmq%E9%95%9C%E5%83%8F%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE" aria-hidden="true">#</a> （4）RabbitMQ镜像集群配置</h4><blockquote><p>上面已经完成RabbitMQ默认集群模式，但并不保证队列的高可用性，尽管交换机、绑定这些可以复制到集群里的任何一个节点，但是队列内容不会复制。虽然该模式解决一项目组节点压力，但队列节点宕机直接导致该队列无法应用，只能等待重启，所以要想在队列节点宕机或故障也能正常应用，就要复制队列内容到集群里的每个节点，必须要创建镜像队列。</p><p>镜像队列是基于普通的集群模式的，然后再添加一些策略，所以你还是得先配置普通集群，然后才能设置镜像队列，我们就以上面的集群接着做。</p></blockquote><p><strong>设置的镜像队列可以通过开启的网页的管理端Admin-&gt;Policies，也可以通过命令。</strong></p><blockquote><p>rabbitmqctl set_policy my_ha "^" '{"ha-mode":"all"}'</p></blockquote><p><img src="./RabbitMQ_files/1566072300852.f79b7823.png" alt="1566072300852" class="medium-zoom-image"></p><blockquote><ul><li>Name:策略名称</li><li>Pattern：匹配的规则，如果是匹配所有的队列，是^.</li><li>Definition:使用ha-mode模式中的all，也就是同步所有匹配的队列。问号链接帮助文档。</li></ul></blockquote><h4 id="_5-负载均衡-haproxy" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#_5-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-haproxy" aria-hidden="true">#</a> （5）负载均衡-HAProxy</h4><p>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案,包括Twitter，Reddit，StackOverflow，GitHub在内的多家知名互联网公司在使用。HAProxy实现了一种事件驱动、单一进程模型，此模型支持非常大的并发连接数。</p><h5 id="a、-安装haproxy" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#a%E3%80%81-%E5%AE%89%E8%A3%85haproxy" aria-hidden="true">#</a> a、 安装HAProxy</h5><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>//下载依赖包
yum <span class="token function">install</span> gcc <span class="token function">vim</span> <span class="token function">wget</span>
//上传haproxy源码包
//解压
<span class="token function">tar</span> -zxvf haproxy-1.6.5.tar.gz -C /usr/local
//进入目录、进行编译、安装
<span class="token builtin class-name">cd</span> /usr/local/haproxy-1.6.5
<span class="token function">make</span> <span class="token assign-left variable">TARGET</span><span class="token operator">=</span>linux31 <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy
<span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy
<span class="token function">mkdir</span> /etc/haproxy
//赋权
<span class="token function">groupadd</span> -r -g <span class="token number">149</span> haproxy
<span class="token function">useradd</span> -g haproxy -r -s /sbin/nologin -u <span class="token number">149</span> haproxy
//创建haproxy配置文件
<span class="token function">mkdir</span> /etc/haproxy
<span class="token function">vim</span> /etc/haproxy/haproxy.cfg
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h5 id="b、配置haproxy" tabindex="-1"><a class="header-anchor" href="https://www.ydlclass.com/doc21xnv/distribute/rabbitmq/#b%E3%80%81%E9%85%8D%E7%BD%AEhaproxy" aria-hidden="true">#</a> b、配置HAProxy</h5><p>配置文件路径：/etc/haproxy/haproxy.cfg</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#logging options</span>
global
	log <span class="token number">127.0</span>.0.1 local0 info
	maxconn <span class="token number">5120</span>
	<span class="token function">chroot</span> /usr/local/haproxy
	uid <span class="token number">99</span>
	gid <span class="token number">99</span>
	daemon
	quiet
	nbproc <span class="token number">20</span>
	pidfile /var/run/haproxy.pid

defaults
	log global
	
	mode tcp

	option tcplog
	option dontlognull
	retries <span class="token number">3</span>
	option redispatch
	maxconn <span class="token number">2000</span>
	contimeout 5s
   
     clitimeout 60s

     srvtimeout 15s	
<span class="token comment">#front-end IP for consumers and producters</span>

listen rabbitmq_cluster
	<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:5672
	
	mode tcp
	<span class="token comment">#balance url_param userid</span>
	<span class="token comment">#balance url_param session_id check_post 64</span>
	<span class="token comment">#balance hdr(User-Agent)</span>
	<span class="token comment">#balance hdr(host)</span>
	<span class="token comment">#balance hdr(Host) use_domain_only</span>
	<span class="token comment">#balance rdp-cookie</span>
	<span class="token comment">#balance leastconn</span>
	<span class="token comment">#balance source //ip</span>
	
	balance roundrobin
	
        server node1 <span class="token number">127.0</span>.0.1:5673 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">2</span>
        server node2 <span class="token number">127.0</span>.0.1:5674 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">2</span>

listen stats
	<span class="token builtin class-name">bind</span> <span class="token number">172.16</span>.98.133:8100
	mode http
	option httplog
	stats <span class="token builtin class-name">enable</span>
	stats uri /rabbitmq-stats
	stats refresh 5s

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>启动HAproxy负载</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>/usr/local/haproxy/sbin/haproxy -f /etc/haproxy/haproxy.cfg
//查看haproxy进程状态
<span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> haproxy

访问如下地址对mq节点进行监控
http://172.16.98.133:8100/rabbitmq-stats

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>代码中访问mq集群地址，则变为访问haproxy地址:5672</p><p>​</p><p>​</p><p>​</p><p>​</p></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2022/7/14 下午10:31:07</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><span class="contributor" title="email: 510183298@qq.com">it楠老师</span><!----></span></div></footer><!----></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="./RabbitMQ_files/app.73a93177.js" defer=""></script>
  

</body><div id="night-mask" style="position: fixed;top: 0;left: 0;width: 100%;height: 100%;z-index: 2147483647;pointer-events: none;mix-blend-mode: multiply;transition: opacity 0.1s ease 0s;opacity:0.11;display:block;background: #000000;"></div></html>